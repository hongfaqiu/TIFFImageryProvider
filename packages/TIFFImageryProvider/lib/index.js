import { Credit, Event, Rectangle, Cartesian3, Math as Math$1, GeographicTilingScheme, DeveloperError, ImageryLayerFeatureInfo } from 'cesium';
import { fromUrl, Pool } from 'geotiff';

function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gZGVmaW5lKGNvbnN0cnVjdG9yLCBmYWN0b3J5LCBwcm90b3R5cGUpIHsKICAgIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGZhY3RvcnkucHJvdG90eXBlID0gcHJvdG90eXBlOwogICAgcHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY29uc3RydWN0b3I7CiAgfQoKICBmdW5jdGlvbiBleHRlbmQocGFyZW50LCBkZWZpbml0aW9uKSB7CiAgICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICAgIGZvciAodmFyIGtleSBpbiBkZWZpbml0aW9uKSBwcm90b3R5cGVba2V5XSA9IGRlZmluaXRpb25ba2V5XTsKICAgIHJldHVybiBwcm90b3R5cGU7CiAgfQoKICBmdW5jdGlvbiBDb2xvcigpIHt9CgogIHZhciBkYXJrZXIgPSAwLjc7CiAgdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKCiAgdmFyIHJlSSA9ICJcXHMqKFsrLV0/XFxkKylcXHMqIiwKICAgICAgcmVOID0gIlxccyooWystXT8oPzpcXGQqXFwuKT9cXGQrKD86W2VFXVsrLV0/XFxkKyk/KVxccyoiLAogICAgICByZVAgPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pJVxccyoiLAogICAgICByZUhleCA9IC9eIyhbMC05YS1mXXszLDh9KSQvLAogICAgICByZVJnYkludGVnZXIgPSBuZXcgUmVnRXhwKGBecmdiXFwoJHtyZUl9LCR7cmVJfSwke3JlSX1cXCkkYCksCiAgICAgIHJlUmdiUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlUH0sJHtyZVB9LCR7cmVQfVxcKSRgKSwKICAgICAgcmVSZ2JhSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZUl9LCR7cmVJfSwke3JlSX0sJHtyZU59XFwpJGApLAogICAgICByZVJnYmFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlUH0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCksCiAgICAgIHJlSHNsUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xcXCgke3JlTn0sJHtyZVB9LCR7cmVQfVxcKSRgKSwKICAgICAgcmVIc2xhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xhXFwoJHtyZU59LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwoKICB2YXIgbmFtZWQgPSB7CiAgICBhbGljZWJsdWU6IDB4ZjBmOGZmLAogICAgYW50aXF1ZXdoaXRlOiAweGZhZWJkNywKICAgIGFxdWE6IDB4MDBmZmZmLAogICAgYXF1YW1hcmluZTogMHg3ZmZmZDQsCiAgICBhenVyZTogMHhmMGZmZmYsCiAgICBiZWlnZTogMHhmNWY1ZGMsCiAgICBiaXNxdWU6IDB4ZmZlNGM0LAogICAgYmxhY2s6IDB4MDAwMDAwLAogICAgYmxhbmNoZWRhbG1vbmQ6IDB4ZmZlYmNkLAogICAgYmx1ZTogMHgwMDAwZmYsCiAgICBibHVldmlvbGV0OiAweDhhMmJlMiwKICAgIGJyb3duOiAweGE1MmEyYSwKICAgIGJ1cmx5d29vZDogMHhkZWI4ODcsCiAgICBjYWRldGJsdWU6IDB4NWY5ZWEwLAogICAgY2hhcnRyZXVzZTogMHg3ZmZmMDAsCiAgICBjaG9jb2xhdGU6IDB4ZDI2OTFlLAogICAgY29yYWw6IDB4ZmY3ZjUwLAogICAgY29ybmZsb3dlcmJsdWU6IDB4NjQ5NWVkLAogICAgY29ybnNpbGs6IDB4ZmZmOGRjLAogICAgY3JpbXNvbjogMHhkYzE0M2MsCiAgICBjeWFuOiAweDAwZmZmZiwKICAgIGRhcmtibHVlOiAweDAwMDA4YiwKICAgIGRhcmtjeWFuOiAweDAwOGI4YiwKICAgIGRhcmtnb2xkZW5yb2Q6IDB4Yjg4NjBiLAogICAgZGFya2dyYXk6IDB4YTlhOWE5LAogICAgZGFya2dyZWVuOiAweDAwNjQwMCwKICAgIGRhcmtncmV5OiAweGE5YTlhOSwKICAgIGRhcmtraGFraTogMHhiZGI3NmIsCiAgICBkYXJrbWFnZW50YTogMHg4YjAwOGIsCiAgICBkYXJrb2xpdmVncmVlbjogMHg1NTZiMmYsCiAgICBkYXJrb3JhbmdlOiAweGZmOGMwMCwKICAgIGRhcmtvcmNoaWQ6IDB4OTkzMmNjLAogICAgZGFya3JlZDogMHg4YjAwMDAsCiAgICBkYXJrc2FsbW9uOiAweGU5OTY3YSwKICAgIGRhcmtzZWFncmVlbjogMHg4ZmJjOGYsCiAgICBkYXJrc2xhdGVibHVlOiAweDQ4M2Q4YiwKICAgIGRhcmtzbGF0ZWdyYXk6IDB4MmY0ZjRmLAogICAgZGFya3NsYXRlZ3JleTogMHgyZjRmNGYsCiAgICBkYXJrdHVycXVvaXNlOiAweDAwY2VkMSwKICAgIGRhcmt2aW9sZXQ6IDB4OTQwMGQzLAogICAgZGVlcHBpbms6IDB4ZmYxNDkzLAogICAgZGVlcHNreWJsdWU6IDB4MDBiZmZmLAogICAgZGltZ3JheTogMHg2OTY5NjksCiAgICBkaW1ncmV5OiAweDY5Njk2OSwKICAgIGRvZGdlcmJsdWU6IDB4MWU5MGZmLAogICAgZmlyZWJyaWNrOiAweGIyMjIyMiwKICAgIGZsb3JhbHdoaXRlOiAweGZmZmFmMCwKICAgIGZvcmVzdGdyZWVuOiAweDIyOGIyMiwKICAgIGZ1Y2hzaWE6IDB4ZmYwMGZmLAogICAgZ2FpbnNib3JvOiAweGRjZGNkYywKICAgIGdob3N0d2hpdGU6IDB4ZjhmOGZmLAogICAgZ29sZDogMHhmZmQ3MDAsCiAgICBnb2xkZW5yb2Q6IDB4ZGFhNTIwLAogICAgZ3JheTogMHg4MDgwODAsCiAgICBncmVlbjogMHgwMDgwMDAsCiAgICBncmVlbnllbGxvdzogMHhhZGZmMmYsCiAgICBncmV5OiAweDgwODA4MCwKICAgIGhvbmV5ZGV3OiAweGYwZmZmMCwKICAgIGhvdHBpbms6IDB4ZmY2OWI0LAogICAgaW5kaWFucmVkOiAweGNkNWM1YywKICAgIGluZGlnbzogMHg0YjAwODIsCiAgICBpdm9yeTogMHhmZmZmZjAsCiAgICBraGFraTogMHhmMGU2OGMsCiAgICBsYXZlbmRlcjogMHhlNmU2ZmEsCiAgICBsYXZlbmRlcmJsdXNoOiAweGZmZjBmNSwKICAgIGxhd25ncmVlbjogMHg3Y2ZjMDAsCiAgICBsZW1vbmNoaWZmb246IDB4ZmZmYWNkLAogICAgbGlnaHRibHVlOiAweGFkZDhlNiwKICAgIGxpZ2h0Y29yYWw6IDB4ZjA4MDgwLAogICAgbGlnaHRjeWFuOiAweGUwZmZmZiwKICAgIGxpZ2h0Z29sZGVucm9keWVsbG93OiAweGZhZmFkMiwKICAgIGxpZ2h0Z3JheTogMHhkM2QzZDMsCiAgICBsaWdodGdyZWVuOiAweDkwZWU5MCwKICAgIGxpZ2h0Z3JleTogMHhkM2QzZDMsCiAgICBsaWdodHBpbms6IDB4ZmZiNmMxLAogICAgbGlnaHRzYWxtb246IDB4ZmZhMDdhLAogICAgbGlnaHRzZWFncmVlbjogMHgyMGIyYWEsCiAgICBsaWdodHNreWJsdWU6IDB4ODdjZWZhLAogICAgbGlnaHRzbGF0ZWdyYXk6IDB4Nzc4ODk5LAogICAgbGlnaHRzbGF0ZWdyZXk6IDB4Nzc4ODk5LAogICAgbGlnaHRzdGVlbGJsdWU6IDB4YjBjNGRlLAogICAgbGlnaHR5ZWxsb3c6IDB4ZmZmZmUwLAogICAgbGltZTogMHgwMGZmMDAsCiAgICBsaW1lZ3JlZW46IDB4MzJjZDMyLAogICAgbGluZW46IDB4ZmFmMGU2LAogICAgbWFnZW50YTogMHhmZjAwZmYsCiAgICBtYXJvb246IDB4ODAwMDAwLAogICAgbWVkaXVtYXF1YW1hcmluZTogMHg2NmNkYWEsCiAgICBtZWRpdW1ibHVlOiAweDAwMDBjZCwKICAgIG1lZGl1bW9yY2hpZDogMHhiYTU1ZDMsCiAgICBtZWRpdW1wdXJwbGU6IDB4OTM3MGRiLAogICAgbWVkaXVtc2VhZ3JlZW46IDB4M2NiMzcxLAogICAgbWVkaXVtc2xhdGVibHVlOiAweDdiNjhlZSwKICAgIG1lZGl1bXNwcmluZ2dyZWVuOiAweDAwZmE5YSwKICAgIG1lZGl1bXR1cnF1b2lzZTogMHg0OGQxY2MsCiAgICBtZWRpdW12aW9sZXRyZWQ6IDB4YzcxNTg1LAogICAgbWlkbmlnaHRibHVlOiAweDE5MTk3MCwKICAgIG1pbnRjcmVhbTogMHhmNWZmZmEsCiAgICBtaXN0eXJvc2U6IDB4ZmZlNGUxLAogICAgbW9jY2FzaW46IDB4ZmZlNGI1LAogICAgbmF2YWpvd2hpdGU6IDB4ZmZkZWFkLAogICAgbmF2eTogMHgwMDAwODAsCiAgICBvbGRsYWNlOiAweGZkZjVlNiwKICAgIG9saXZlOiAweDgwODAwMCwKICAgIG9saXZlZHJhYjogMHg2YjhlMjMsCiAgICBvcmFuZ2U6IDB4ZmZhNTAwLAogICAgb3JhbmdlcmVkOiAweGZmNDUwMCwKICAgIG9yY2hpZDogMHhkYTcwZDYsCiAgICBwYWxlZ29sZGVucm9kOiAweGVlZThhYSwKICAgIHBhbGVncmVlbjogMHg5OGZiOTgsCiAgICBwYWxldHVycXVvaXNlOiAweGFmZWVlZSwKICAgIHBhbGV2aW9sZXRyZWQ6IDB4ZGI3MDkzLAogICAgcGFwYXlhd2hpcDogMHhmZmVmZDUsCiAgICBwZWFjaHB1ZmY6IDB4ZmZkYWI5LAogICAgcGVydTogMHhjZDg1M2YsCiAgICBwaW5rOiAweGZmYzBjYiwKICAgIHBsdW06IDB4ZGRhMGRkLAogICAgcG93ZGVyYmx1ZTogMHhiMGUwZTYsCiAgICBwdXJwbGU6IDB4ODAwMDgwLAogICAgcmViZWNjYXB1cnBsZTogMHg2NjMzOTksCiAgICByZWQ6IDB4ZmYwMDAwLAogICAgcm9zeWJyb3duOiAweGJjOGY4ZiwKICAgIHJveWFsYmx1ZTogMHg0MTY5ZTEsCiAgICBzYWRkbGVicm93bjogMHg4YjQ1MTMsCiAgICBzYWxtb246IDB4ZmE4MDcyLAogICAgc2FuZHlicm93bjogMHhmNGE0NjAsCiAgICBzZWFncmVlbjogMHgyZThiNTcsCiAgICBzZWFzaGVsbDogMHhmZmY1ZWUsCiAgICBzaWVubmE6IDB4YTA1MjJkLAogICAgc2lsdmVyOiAweGMwYzBjMCwKICAgIHNreWJsdWU6IDB4ODdjZWViLAogICAgc2xhdGVibHVlOiAweDZhNWFjZCwKICAgIHNsYXRlZ3JheTogMHg3MDgwOTAsCiAgICBzbGF0ZWdyZXk6IDB4NzA4MDkwLAogICAgc25vdzogMHhmZmZhZmEsCiAgICBzcHJpbmdncmVlbjogMHgwMGZmN2YsCiAgICBzdGVlbGJsdWU6IDB4NDY4MmI0LAogICAgdGFuOiAweGQyYjQ4YywKICAgIHRlYWw6IDB4MDA4MDgwLAogICAgdGhpc3RsZTogMHhkOGJmZDgsCiAgICB0b21hdG86IDB4ZmY2MzQ3LAogICAgdHVycXVvaXNlOiAweDQwZTBkMCwKICAgIHZpb2xldDogMHhlZTgyZWUsCiAgICB3aGVhdDogMHhmNWRlYjMsCiAgICB3aGl0ZTogMHhmZmZmZmYsCiAgICB3aGl0ZXNtb2tlOiAweGY1ZjVmNSwKICAgIHllbGxvdzogMHhmZmZmMDAsCiAgICB5ZWxsb3dncmVlbjogMHg5YWNkMzIKICB9OwoKICBkZWZpbmUoQ29sb3IsIGNvbG9yLCB7CiAgICBjb3B5KGNoYW5uZWxzKSB7CiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyB0aGlzLmNvbnN0cnVjdG9yLCB0aGlzLCBjaGFubmVscyk7CiAgICB9LAogICAgZGlzcGxheWFibGUoKSB7CiAgICAgIHJldHVybiB0aGlzLnJnYigpLmRpc3BsYXlhYmxlKCk7CiAgICB9LAogICAgaGV4OiBjb2xvcl9mb3JtYXRIZXgsIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgICBmb3JtYXRIZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAgIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgICBmb3JtYXRIc2w6IGNvbG9yX2Zvcm1hdEhzbCwKICAgIGZvcm1hdFJnYjogY29sb3JfZm9ybWF0UmdiLAogICAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgogIH0pOwoKICBmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXgoKSB7CiAgICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXgoKTsKICB9CgogIGZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleDgoKSB7CiAgICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXg4KCk7CiAgfQoKICBmdW5jdGlvbiBjb2xvcl9mb3JtYXRIc2woKSB7CiAgICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKICB9CgogIGZ1bmN0aW9uIGNvbG9yX2Zvcm1hdFJnYigpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdFJnYigpOwogIH0KCiAgZnVuY3Rpb24gY29sb3IoZm9ybWF0KSB7CiAgICB2YXIgbSwgbDsKICAgIGZvcm1hdCA9IChmb3JtYXQgKyAiIikudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgICByZXR1cm4gKG0gPSByZUhleC5leGVjKGZvcm1hdCkpID8gKGwgPSBtWzFdLmxlbmd0aCwgbSA9IHBhcnNlSW50KG1bMV0sIDE2KSwgbCA9PT0gNiA/IHJnYm4obSkgLy8gI2ZmMDAwMAogICAgICAgIDogbCA9PT0gMyA/IG5ldyBSZ2IoKG0gPj4gOCAmIDB4ZikgfCAobSA+PiA0ICYgMHhmMCksIChtID4+IDQgJiAweGYpIHwgKG0gJiAweGYwKSwgKChtICYgMHhmKSA8PCA0KSB8IChtICYgMHhmKSwgMSkgLy8gI2YwMAogICAgICAgIDogbCA9PT0gOCA/IHJnYmEobSA+PiAyNCAmIDB4ZmYsIG0gPj4gMTYgJiAweGZmLCBtID4+IDggJiAweGZmLCAobSAmIDB4ZmYpIC8gMHhmZikgLy8gI2ZmMDAwMDAwCiAgICAgICAgOiBsID09PSA0ID8gcmdiYSgobSA+PiAxMiAmIDB4ZikgfCAobSA+PiA4ICYgMHhmMCksIChtID4+IDggJiAweGYpIHwgKG0gPj4gNCAmIDB4ZjApLCAobSA+PiA0ICYgMHhmKSB8IChtICYgMHhmMCksICgoKG0gJiAweGYpIDw8IDQpIHwgKG0gJiAweGYpKSAvIDB4ZmYpIC8vICNmMDAwCiAgICAgICAgOiBudWxsKSAvLyBpbnZhbGlkIGhleAogICAgICAgIDogKG0gPSByZVJnYkludGVnZXIuZXhlYyhmb3JtYXQpKSA/IG5ldyBSZ2IobVsxXSwgbVsyXSwgbVszXSwgMSkgLy8gcmdiKDI1NSwgMCwgMCkKICAgICAgICA6IChtID0gcmVSZ2JQZXJjZW50LmV4ZWMoZm9ybWF0KSkgPyBuZXcgUmdiKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIDEpIC8vIHJnYigxMDAlLCAwJSwgMCUpCiAgICAgICAgOiAobSA9IHJlUmdiYUludGVnZXIuZXhlYyhmb3JtYXQpKSA/IHJnYmEobVsxXSwgbVsyXSwgbVszXSwgbVs0XSkgLy8gcmdiYSgyNTUsIDAsIDAsIDEpCiAgICAgICAgOiAobSA9IHJlUmdiYVBlcmNlbnQuZXhlYyhmb3JtYXQpKSA/IHJnYmEobVsxXSAqIDI1NSAvIDEwMCwgbVsyXSAqIDI1NSAvIDEwMCwgbVszXSAqIDI1NSAvIDEwMCwgbVs0XSkgLy8gcmdiKDEwMCUsIDAlLCAwJSwgMSkKICAgICAgICA6IChtID0gcmVIc2xQZXJjZW50LmV4ZWMoZm9ybWF0KSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIDEpIC8vIGhzbCgxMjAsIDUwJSwgNTAlKQogICAgICAgIDogKG0gPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0KSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIG1bNF0pIC8vIGhzbGEoMTIwLCA1MCUsIDUwJSwgMSkKICAgICAgICA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdCkgPyByZ2JuKG5hbWVkW2Zvcm1hdF0pIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zCiAgICAgICAgOiBmb3JtYXQgPT09ICJ0cmFuc3BhcmVudCIgPyBuZXcgUmdiKE5hTiwgTmFOLCBOYU4sIDApCiAgICAgICAgOiBudWxsOwogIH0KCiAgZnVuY3Rpb24gcmdibihuKSB7CiAgICByZXR1cm4gbmV3IFJnYihuID4+IDE2ICYgMHhmZiwgbiA+PiA4ICYgMHhmZiwgbiAmIDB4ZmYsIDEpOwogIH0KCiAgZnVuY3Rpb24gcmdiYShyLCBnLCBiLCBhKSB7CiAgICBpZiAoYSA8PSAwKSByID0gZyA9IGIgPSBOYU47CiAgICByZXR1cm4gbmV3IFJnYihyLCBnLCBiLCBhKTsKICB9CgogIGZ1bmN0aW9uIHJnYkNvbnZlcnQobykgewogICAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogICAgaWYgKCFvKSByZXR1cm4gbmV3IFJnYjsKICAgIG8gPSBvLnJnYigpOwogICAgcmV0dXJuIG5ldyBSZ2Ioby5yLCBvLmcsIG8uYiwgby5vcGFjaXR5KTsKICB9CgogIGZ1bmN0aW9uIHJnYihyLCBnLCBiLCBvcGFjaXR5KSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHJnYkNvbnZlcnQocikgOiBuZXcgUmdiKHIsIGcsIGIsIG9wYWNpdHkgPT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKICB9CgogIGZ1bmN0aW9uIFJnYihyLCBnLCBiLCBvcGFjaXR5KSB7CiAgICB0aGlzLnIgPSArcjsKICAgIHRoaXMuZyA9ICtnOwogICAgdGhpcy5iID0gK2I7CiAgICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKICB9CgogIGRlZmluZShSZ2IsIHJnYiwgZXh0ZW5kKENvbG9yLCB7CiAgICBicmlnaHRlcihrKSB7CiAgICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICBkYXJrZXIoaykgewogICAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICByZ2IoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGNsYW1wKCkgewogICAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgICB9LAogICAgZGlzcGxheWFibGUoKSB7CiAgICAgIHJldHVybiAoLTAuNSA8PSB0aGlzLnIgJiYgdGhpcy5yIDwgMjU1LjUpCiAgICAgICAgICAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpCiAgICAgICAgICAmJiAoLTAuNSA8PSB0aGlzLmIgJiYgdGhpcy5iIDwgMjU1LjUpCiAgICAgICAgICAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogICAgfSwKICAgIGhleDogcmdiX2Zvcm1hdEhleCwgLy8gRGVwcmVjYXRlZCEgVXNlIGNvbG9yLmZvcm1hdEhleC4KICAgIGZvcm1hdEhleDogcmdiX2Zvcm1hdEhleCwKICAgIGZvcm1hdEhleDg6IHJnYl9mb3JtYXRIZXg4LAogICAgZm9ybWF0UmdiOiByZ2JfZm9ybWF0UmdiLAogICAgdG9TdHJpbmc6IHJnYl9mb3JtYXRSZ2IKICB9KSk7CgogIGZ1bmN0aW9uIHJnYl9mb3JtYXRIZXgoKSB7CiAgICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX1gOwogIH0KCiAgZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX0ke2hleCgoaXNOYU4odGhpcy5vcGFjaXR5KSA/IDEgOiB0aGlzLm9wYWNpdHkpICogMjU1KX1gOwogIH0KCiAgZnVuY3Rpb24gcmdiX2Zvcm1hdFJnYigpIHsKICAgIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthID09PSAxID8gInJnYigiIDogInJnYmEoIn0ke2NsYW1waSh0aGlzLnIpfSwgJHtjbGFtcGkodGhpcy5nKX0sICR7Y2xhbXBpKHRoaXMuYil9JHthID09PSAxID8gIikiIDogYCwgJHthfSlgfWA7CiAgfQoKICBmdW5jdGlvbiBjbGFtcGEob3BhY2l0eSkgewogICAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKICB9CgogIGZ1bmN0aW9uIGNsYW1waSh2YWx1ZSkgewogICAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDI1NSwgTWF0aC5yb3VuZCh2YWx1ZSkgfHwgMCkpOwogIH0KCiAgZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgICB2YWx1ZSA9IGNsYW1waSh2YWx1ZSk7CiAgICByZXR1cm4gKHZhbHVlIDwgMTYgPyAiMCIgOiAiIikgKyB2YWx1ZS50b1N0cmluZygxNik7CiAgfQoKICBmdW5jdGlvbiBoc2xhKGgsIHMsIGwsIGEpIHsKICAgIGlmIChhIDw9IDApIGggPSBzID0gbCA9IE5hTjsKICAgIGVsc2UgaWYgKGwgPD0gMCB8fCBsID49IDEpIGggPSBzID0gTmFOOwogICAgZWxzZSBpZiAocyA8PSAwKSBoID0gTmFOOwogICAgcmV0dXJuIG5ldyBIc2woaCwgcywgbCwgYSk7CiAgfQoKICBmdW5jdGlvbiBoc2xDb252ZXJ0KG8pIHsKICAgIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbmV3IEhzbChvLmgsIG8ucywgby5sLCBvLm9wYWNpdHkpOwogICAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogICAgaWYgKCFvKSByZXR1cm4gbmV3IEhzbDsKICAgIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbzsKICAgIG8gPSBvLnJnYigpOwogICAgdmFyIHIgPSBvLnIgLyAyNTUsCiAgICAgICAgZyA9IG8uZyAvIDI1NSwKICAgICAgICBiID0gby5iIC8gMjU1LAogICAgICAgIG1pbiA9IE1hdGgubWluKHIsIGcsIGIpLAogICAgICAgIG1heCA9IE1hdGgubWF4KHIsIGcsIGIpLAogICAgICAgIGggPSBOYU4sCiAgICAgICAgcyA9IG1heCAtIG1pbiwKICAgICAgICBsID0gKG1heCArIG1pbikgLyAyOwogICAgaWYgKHMpIHsKICAgICAgaWYgKHIgPT09IG1heCkgaCA9IChnIC0gYikgLyBzICsgKGcgPCBiKSAqIDY7CiAgICAgIGVsc2UgaWYgKGcgPT09IG1heCkgaCA9IChiIC0gcikgLyBzICsgMjsKICAgICAgZWxzZSBoID0gKHIgLSBnKSAvIHMgKyA0OwogICAgICBzIC89IGwgPCAwLjUgPyBtYXggKyBtaW4gOiAyIC0gbWF4IC0gbWluOwogICAgICBoICo9IDYwOwogICAgfSBlbHNlIHsKICAgICAgcyA9IGwgPiAwICYmIGwgPCAxID8gMCA6IGg7CiAgICB9CiAgICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBvLm9wYWNpdHkpOwogIH0KCiAgZnVuY3Rpb24gaHNsJDEoaCwgcywgbCwgb3BhY2l0eSkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBoc2xDb252ZXJ0KGgpIDogbmV3IEhzbChoLCBzLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7CiAgfQoKICBmdW5jdGlvbiBIc2woaCwgcywgbCwgb3BhY2l0eSkgewogICAgdGhpcy5oID0gK2g7CiAgICB0aGlzLnMgPSArczsKICAgIHRoaXMubCA9ICtsOwogICAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7CiAgfQoKICBkZWZpbmUoSHNsLCBoc2wkMSwgZXh0ZW5kKENvbG9yLCB7CiAgICBicmlnaHRlcihrKSB7CiAgICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgICB9LAogICAgZGFya2VyKGspIHsKICAgICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICAgIHJldHVybiBuZXcgSHNsKHRoaXMuaCwgdGhpcy5zLCB0aGlzLmwgKiBrLCB0aGlzLm9wYWNpdHkpOwogICAgfSwKICAgIHJnYigpIHsKICAgICAgdmFyIGggPSB0aGlzLmggJSAzNjAgKyAodGhpcy5oIDwgMCkgKiAzNjAsCiAgICAgICAgICBzID0gaXNOYU4oaCkgfHwgaXNOYU4odGhpcy5zKSA/IDAgOiB0aGlzLnMsCiAgICAgICAgICBsID0gdGhpcy5sLAogICAgICAgICAgbTIgPSBsICsgKGwgPCAwLjUgPyBsIDogMSAtIGwpICogcywKICAgICAgICAgIG0xID0gMiAqIGwgLSBtMjsKICAgICAgcmV0dXJuIG5ldyBSZ2IoCiAgICAgICAgaHNsMnJnYihoID49IDI0MCA/IGggLSAyNDAgOiBoICsgMTIwLCBtMSwgbTIpLAogICAgICAgIGhzbDJyZ2IoaCwgbTEsIG0yKSwKICAgICAgICBoc2wycmdiKGggPCAxMjAgPyBoICsgMjQwIDogaCAtIDEyMCwgbTEsIG0yKSwKICAgICAgICB0aGlzLm9wYWNpdHkKICAgICAgKTsKICAgIH0sCiAgICBjbGFtcCgpIHsKICAgICAgcmV0dXJuIG5ldyBIc2woY2xhbXBoKHRoaXMuaCksIGNsYW1wdCh0aGlzLnMpLCBjbGFtcHQodGhpcy5sKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogICAgfSwKICAgIGRpc3BsYXlhYmxlKCkgewogICAgICByZXR1cm4gKDAgPD0gdGhpcy5zICYmIHRoaXMucyA8PSAxIHx8IGlzTmFOKHRoaXMucykpCiAgICAgICAgICAmJiAoMCA8PSB0aGlzLmwgJiYgdGhpcy5sIDw9IDEpCiAgICAgICAgICAmJiAoMCA8PSB0aGlzLm9wYWNpdHkgJiYgdGhpcy5vcGFjaXR5IDw9IDEpOwogICAgfSwKICAgIGZvcm1hdEhzbCgpIHsKICAgICAgY29uc3QgYSA9IGNsYW1wYSh0aGlzLm9wYWNpdHkpOwogICAgICByZXR1cm4gYCR7YSA9PT0gMSA/ICJoc2woIiA6ICJoc2xhKCJ9JHtjbGFtcGgodGhpcy5oKX0sICR7Y2xhbXB0KHRoaXMucykgKiAxMDB9JSwgJHtjbGFtcHQodGhpcy5sKSAqIDEwMH0lJHthID09PSAxID8gIikiIDogYCwgJHthfSlgfWA7CiAgICB9CiAgfSkpOwoKICBmdW5jdGlvbiBjbGFtcGgodmFsdWUpIHsKICAgIHZhbHVlID0gKHZhbHVlIHx8IDApICUgMzYwOwogICAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBjbGFtcHQodmFsdWUpIHsKICAgIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB2YWx1ZSB8fCAwKSk7CiAgfQoKICAvKiBGcm9tIEZ2RCAxMy4zNywgQ1NTIENvbG9yIE1vZHVsZSBMZXZlbCAzICovCiAgZnVuY3Rpb24gaHNsMnJnYihoLCBtMSwgbTIpIHsKICAgIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAKICAgICAgICA6IGggPCAxODAgPyBtMgogICAgICAgIDogaCA8IDI0MCA/IG0xICsgKG0yIC0gbTEpICogKDI0MCAtIGgpIC8gNjAKICAgICAgICA6IG0xKSAqIDI1NTsKICB9CgogIGNvbnN0IHJhZGlhbnMgPSBNYXRoLlBJIC8gMTgwOwogIGNvbnN0IGRlZ3JlZXMgPSAxODAgLyBNYXRoLlBJOwoKICAvLyBodHRwczovL29ic2VydmFibGVocS5jb20vQG1ib3N0b2NrL2xhYi1hbmQtcmdiCiAgY29uc3QgSyA9IDE4LAogICAgICBYbiA9IDAuOTY0MjIsCiAgICAgIFluID0gMSwKICAgICAgWm4gPSAwLjgyNTIxLAogICAgICB0MCA9IDQgLyAyOSwKICAgICAgdDEgPSA2IC8gMjksCiAgICAgIHQyID0gMyAqIHQxICogdDEsCiAgICAgIHQzID0gdDEgKiB0MSAqIHQxOwoKICBmdW5jdGlvbiBsYWJDb252ZXJ0KG8pIHsKICAgIGlmIChvIGluc3RhbmNlb2YgTGFiKSByZXR1cm4gbmV3IExhYihvLmwsIG8uYSwgby5iLCBvLm9wYWNpdHkpOwogICAgaWYgKG8gaW5zdGFuY2VvZiBIY2wpIHJldHVybiBoY2wybGFiKG8pOwogICAgaWYgKCEobyBpbnN0YW5jZW9mIFJnYikpIG8gPSByZ2JDb252ZXJ0KG8pOwogICAgdmFyIHIgPSByZ2IybHJnYihvLnIpLAogICAgICAgIGcgPSByZ2IybHJnYihvLmcpLAogICAgICAgIGIgPSByZ2IybHJnYihvLmIpLAogICAgICAgIHkgPSB4eXoybGFiKCgwLjIyMjUwNDUgKiByICsgMC43MTY4Nzg2ICogZyArIDAuMDYwNjE2OSAqIGIpIC8gWW4pLCB4LCB6OwogICAgaWYgKHIgPT09IGcgJiYgZyA9PT0gYikgeCA9IHogPSB5OyBlbHNlIHsKICAgICAgeCA9IHh5ejJsYWIoKDAuNDM2MDc0NyAqIHIgKyAwLjM4NTA2NDkgKiBnICsgMC4xNDMwODA0ICogYikgLyBYbik7CiAgICAgIHogPSB4eXoybGFiKCgwLjAxMzkzMjIgKiByICsgMC4wOTcxMDQ1ICogZyArIDAuNzE0MTczMyAqIGIpIC8gWm4pOwogICAgfQogICAgcmV0dXJuIG5ldyBMYWIoMTE2ICogeSAtIDE2LCA1MDAgKiAoeCAtIHkpLCAyMDAgKiAoeSAtIHopLCBvLm9wYWNpdHkpOwogIH0KCiAgZnVuY3Rpb24gbGFiJDEobCwgYSwgYiwgb3BhY2l0eSkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBsYWJDb252ZXJ0KGwpIDogbmV3IExhYihsLCBhLCBiLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7CiAgfQoKICBmdW5jdGlvbiBMYWIobCwgYSwgYiwgb3BhY2l0eSkgewogICAgdGhpcy5sID0gK2w7CiAgICB0aGlzLmEgPSArYTsKICAgIHRoaXMuYiA9ICtiOwogICAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7CiAgfQoKICBkZWZpbmUoTGFiLCBsYWIkMSwgZXh0ZW5kKENvbG9yLCB7CiAgICBicmlnaHRlcihrKSB7CiAgICAgIHJldHVybiBuZXcgTGFiKHRoaXMubCArIEsgKiAoayA9PSBudWxsID8gMSA6IGspLCB0aGlzLmEsIHRoaXMuYiwgdGhpcy5vcGFjaXR5KTsKICAgIH0sCiAgICBkYXJrZXIoaykgewogICAgICByZXR1cm4gbmV3IExhYih0aGlzLmwgLSBLICogKGsgPT0gbnVsbCA/IDEgOiBrKSwgdGhpcy5hLCB0aGlzLmIsIHRoaXMub3BhY2l0eSk7CiAgICB9LAogICAgcmdiKCkgewogICAgICB2YXIgeSA9ICh0aGlzLmwgKyAxNikgLyAxMTYsCiAgICAgICAgICB4ID0gaXNOYU4odGhpcy5hKSA/IHkgOiB5ICsgdGhpcy5hIC8gNTAwLAogICAgICAgICAgeiA9IGlzTmFOKHRoaXMuYikgPyB5IDogeSAtIHRoaXMuYiAvIDIwMDsKICAgICAgeCA9IFhuICogbGFiMnh5eih4KTsKICAgICAgeSA9IFluICogbGFiMnh5eih5KTsKICAgICAgeiA9IFpuICogbGFiMnh5eih6KTsKICAgICAgcmV0dXJuIG5ldyBSZ2IoCiAgICAgICAgbHJnYjJyZ2IoIDMuMTMzODU2MSAqIHggLSAxLjYxNjg2NjcgKiB5IC0gMC40OTA2MTQ2ICogeiksCiAgICAgICAgbHJnYjJyZ2IoLTAuOTc4NzY4NCAqIHggKyAxLjkxNjE0MTUgKiB5ICsgMC4wMzM0NTQwICogeiksCiAgICAgICAgbHJnYjJyZ2IoIDAuMDcxOTQ1MyAqIHggLSAwLjIyODk5MTQgKiB5ICsgMS40MDUyNDI3ICogeiksCiAgICAgICAgdGhpcy5vcGFjaXR5CiAgICAgICk7CiAgICB9CiAgfSkpOwoKICBmdW5jdGlvbiB4eXoybGFiKHQpIHsKICAgIHJldHVybiB0ID4gdDMgPyBNYXRoLnBvdyh0LCAxIC8gMykgOiB0IC8gdDIgKyB0MDsKICB9CgogIGZ1bmN0aW9uIGxhYjJ4eXoodCkgewogICAgcmV0dXJuIHQgPiB0MSA/IHQgKiB0ICogdCA6IHQyICogKHQgLSB0MCk7CiAgfQoKICBmdW5jdGlvbiBscmdiMnJnYih4KSB7CiAgICByZXR1cm4gMjU1ICogKHggPD0gMC4wMDMxMzA4ID8gMTIuOTIgKiB4IDogMS4wNTUgKiBNYXRoLnBvdyh4LCAxIC8gMi40KSAtIDAuMDU1KTsKICB9CgogIGZ1bmN0aW9uIHJnYjJscmdiKHgpIHsKICAgIHJldHVybiAoeCAvPSAyNTUpIDw9IDAuMDQwNDUgPyB4IC8gMTIuOTIgOiBNYXRoLnBvdygoeCArIDAuMDU1KSAvIDEuMDU1LCAyLjQpOwogIH0KCiAgZnVuY3Rpb24gaGNsQ29udmVydChvKSB7CiAgICBpZiAobyBpbnN0YW5jZW9mIEhjbCkgcmV0dXJuIG5ldyBIY2woby5oLCBvLmMsIG8ubCwgby5vcGFjaXR5KTsKICAgIGlmICghKG8gaW5zdGFuY2VvZiBMYWIpKSBvID0gbGFiQ29udmVydChvKTsKICAgIGlmIChvLmEgPT09IDAgJiYgby5iID09PSAwKSByZXR1cm4gbmV3IEhjbChOYU4sIDAgPCBvLmwgJiYgby5sIDwgMTAwID8gMCA6IE5hTiwgby5sLCBvLm9wYWNpdHkpOwogICAgdmFyIGggPSBNYXRoLmF0YW4yKG8uYiwgby5hKSAqIGRlZ3JlZXM7CiAgICByZXR1cm4gbmV3IEhjbChoIDwgMCA/IGggKyAzNjAgOiBoLCBNYXRoLnNxcnQoby5hICogby5hICsgby5iICogby5iKSwgby5sLCBvLm9wYWNpdHkpOwogIH0KCiAgZnVuY3Rpb24gaGNsKGgsIGMsIGwsIG9wYWNpdHkpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gaGNsQ29udmVydChoKSA6IG5ldyBIY2woaCwgYywgbCwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwogIH0KCiAgZnVuY3Rpb24gSGNsKGgsIGMsIGwsIG9wYWNpdHkpIHsKICAgIHRoaXMuaCA9ICtoOwogICAgdGhpcy5jID0gK2M7CiAgICB0aGlzLmwgPSArbDsKICAgIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5OwogIH0KCiAgZnVuY3Rpb24gaGNsMmxhYihvKSB7CiAgICBpZiAoaXNOYU4oby5oKSkgcmV0dXJuIG5ldyBMYWIoby5sLCAwLCAwLCBvLm9wYWNpdHkpOwogICAgdmFyIGggPSBvLmggKiByYWRpYW5zOwogICAgcmV0dXJuIG5ldyBMYWIoby5sLCBNYXRoLmNvcyhoKSAqIG8uYywgTWF0aC5zaW4oaCkgKiBvLmMsIG8ub3BhY2l0eSk7CiAgfQoKICBkZWZpbmUoSGNsLCBoY2wsIGV4dGVuZChDb2xvciwgewogICAgYnJpZ2h0ZXIoaykgewogICAgICByZXR1cm4gbmV3IEhjbCh0aGlzLmgsIHRoaXMuYywgdGhpcy5sICsgSyAqIChrID09IG51bGwgPyAxIDogayksIHRoaXMub3BhY2l0eSk7CiAgICB9LAogICAgZGFya2VyKGspIHsKICAgICAgcmV0dXJuIG5ldyBIY2wodGhpcy5oLCB0aGlzLmMsIHRoaXMubCAtIEsgKiAoayA9PSBudWxsID8gMSA6IGspLCB0aGlzLm9wYWNpdHkpOwogICAgfSwKICAgIHJnYigpIHsKICAgICAgcmV0dXJuIGhjbDJsYWIodGhpcykucmdiKCk7CiAgICB9CiAgfSkpOwoKICB2YXIgY29uc3RhbnQgPSB4ID0+ICgpID0+IHg7CgogIGZ1bmN0aW9uIGxpbmVhciQxKGEsIGQpIHsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHJldHVybiBhICsgdCAqIGQ7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZXhwb25lbnRpYWwoYSwgYiwgeSkgewogICAgcmV0dXJuIGEgPSBNYXRoLnBvdyhhLCB5KSwgYiA9IE1hdGgucG93KGIsIHkpIC0gYSwgeSA9IDEgLyB5LCBmdW5jdGlvbih0KSB7CiAgICAgIHJldHVybiBNYXRoLnBvdyhhICsgdCAqIGIsIHkpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGh1ZShhLCBiKSB7CiAgICB2YXIgZCA9IGIgLSBhOwogICAgcmV0dXJuIGQgPyBsaW5lYXIkMShhLCBkID4gMTgwIHx8IGQgPCAtMTgwID8gZCAtIDM2MCAqIE1hdGgucm91bmQoZCAvIDM2MCkgOiBkKSA6IGNvbnN0YW50KGlzTmFOKGEpID8gYiA6IGEpOwogIH0KCiAgZnVuY3Rpb24gZ2FtbWEoeSkgewogICAgcmV0dXJuICh5ID0gK3kpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgcmV0dXJuIGIgLSBhID8gZXhwb25lbnRpYWwoYSwgYiwgeSkgOiBjb25zdGFudChpc05hTihhKSA/IGIgOiBhKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBub2dhbW1hKGEsIGIpIHsKICAgIHZhciBkID0gYiAtIGE7CiAgICByZXR1cm4gZCA/IGxpbmVhciQxKGEsIGQpIDogY29uc3RhbnQoaXNOYU4oYSkgPyBiIDogYSk7CiAgfQoKICB2YXIgaW50ZXJwb2xhdGVSZ2IgPSAoZnVuY3Rpb24gcmdiR2FtbWEoeSkgewogICAgdmFyIGNvbG9yID0gZ2FtbWEoeSk7CgogICAgZnVuY3Rpb24gcmdiJDEoc3RhcnQsIGVuZCkgewogICAgICB2YXIgciA9IGNvbG9yKChzdGFydCA9IHJnYihzdGFydCkpLnIsIChlbmQgPSByZ2IoZW5kKSkuciksCiAgICAgICAgICBnID0gY29sb3Ioc3RhcnQuZywgZW5kLmcpLAogICAgICAgICAgYiA9IGNvbG9yKHN0YXJ0LmIsIGVuZC5iKSwKICAgICAgICAgIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Lm9wYWNpdHksIGVuZC5vcGFjaXR5KTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICBzdGFydC5yID0gcih0KTsKICAgICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgICBzdGFydC5iID0gYih0KTsKICAgICAgICBzdGFydC5vcGFjaXR5ID0gb3BhY2l0eSh0KTsKICAgICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgICAgfTsKICAgIH0KCiAgICByZ2IkMS5nYW1tYSA9IHJnYkdhbW1hOwoKICAgIHJldHVybiByZ2IkMTsKICB9KSgxKTsKCiAgZnVuY3Rpb24gbnVtYmVyQXJyYXkoYSwgYikgewogICAgaWYgKCFiKSBiID0gW107CiAgICB2YXIgbiA9IGEgPyBNYXRoLm1pbihiLmxlbmd0aCwgYS5sZW5ndGgpIDogMCwKICAgICAgICBjID0gYi5zbGljZSgpLAogICAgICAgIGk7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSBjW2ldID0gYVtpXSAqICgxIC0gdCkgKyBiW2ldICogdDsKICAgICAgcmV0dXJuIGM7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaXNOdW1iZXJBcnJheSh4KSB7CiAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgpICYmICEoeCBpbnN0YW5jZW9mIERhdGFWaWV3KTsKICB9CgogIGZ1bmN0aW9uIGdlbmVyaWNBcnJheShhLCBiKSB7CiAgICB2YXIgbmIgPSBiID8gYi5sZW5ndGggOiAwLAogICAgICAgIG5hID0gYSA/IE1hdGgubWluKG5iLCBhLmxlbmd0aCkgOiAwLAogICAgICAgIHggPSBuZXcgQXJyYXkobmEpLAogICAgICAgIGMgPSBuZXcgQXJyYXkobmIpLAogICAgICAgIGk7CgogICAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIHhbaV0gPSBpbnRlcnBvbGF0ZShhW2ldLCBiW2ldKTsKICAgIGZvciAoOyBpIDwgbmI7ICsraSkgY1tpXSA9IGJbaV07CgogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIGNbaV0gPSB4W2ldKHQpOwogICAgICByZXR1cm4gYzsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBkYXRlKGEsIGIpIHsKICAgIHZhciBkID0gbmV3IERhdGU7CiAgICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgICAgcmV0dXJuIGQuc2V0VGltZShhICogKDEgLSB0KSArIGIgKiB0KSwgZDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBpbnRlcnBvbGF0ZU51bWJlcihhLCBiKSB7CiAgICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgICAgcmV0dXJuIGEgKiAoMSAtIHQpICsgYiAqIHQ7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gb2JqZWN0KGEsIGIpIHsKICAgIHZhciBpID0ge30sCiAgICAgICAgYyA9IHt9LAogICAgICAgIGs7CgogICAgaWYgKGEgPT09IG51bGwgfHwgdHlwZW9mIGEgIT09ICJvYmplY3QiKSBhID0ge307CiAgICBpZiAoYiA9PT0gbnVsbCB8fCB0eXBlb2YgYiAhPT0gIm9iamVjdCIpIGIgPSB7fTsKCiAgICBmb3IgKGsgaW4gYikgewogICAgICBpZiAoayBpbiBhKSB7CiAgICAgICAgaVtrXSA9IGludGVycG9sYXRlKGFba10sIGJba10pOwogICAgICB9IGVsc2UgewogICAgICAgIGNba10gPSBiW2tdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgZm9yIChrIGluIGkpIGNba10gPSBpW2tdKHQpOwogICAgICByZXR1cm4gYzsKICAgIH07CiAgfQoKICB2YXIgcmVBID0gL1stK10/KD86XGQrXC4/XGQqfFwuP1xkKykoPzpbZUVdWy0rXT9cZCspPy9nLAogICAgICByZUIgPSBuZXcgUmVnRXhwKHJlQS5zb3VyY2UsICJnIik7CgogIGZ1bmN0aW9uIHplcm8kMShiKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBiOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIG9uZShiKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICByZXR1cm4gYih0KSArICIiOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHN0cmluZyhhLCBiKSB7CiAgICB2YXIgYmkgPSByZUEubGFzdEluZGV4ID0gcmVCLmxhc3RJbmRleCA9IDAsIC8vIHNjYW4gaW5kZXggZm9yIG5leHQgbnVtYmVyIGluIGIKICAgICAgICBhbSwgLy8gY3VycmVudCBtYXRjaCBpbiBhCiAgICAgICAgYm0sIC8vIGN1cnJlbnQgbWF0Y2ggaW4gYgogICAgICAgIGJzLCAvLyBzdHJpbmcgcHJlY2VkaW5nIGN1cnJlbnQgbnVtYmVyIGluIGIsIGlmIGFueQogICAgICAgIGkgPSAtMSwgLy8gaW5kZXggaW4gcwogICAgICAgIHMgPSBbXSwgLy8gc3RyaW5nIGNvbnN0YW50cyBhbmQgcGxhY2Vob2xkZXJzCiAgICAgICAgcSA9IFtdOyAvLyBudW1iZXIgaW50ZXJwb2xhdG9ycwoKICAgIC8vIENvZXJjZSBpbnB1dHMgdG8gc3RyaW5ncy4KICAgIGEgPSBhICsgIiIsIGIgPSBiICsgIiI7CgogICAgLy8gSW50ZXJwb2xhdGUgcGFpcnMgb2YgbnVtYmVycyBpbiBhICYgYi4KICAgIHdoaWxlICgoYW0gPSByZUEuZXhlYyhhKSkKICAgICAgICAmJiAoYm0gPSByZUIuZXhlYyhiKSkpIHsKICAgICAgaWYgKChicyA9IGJtLmluZGV4KSA+IGJpKSB7IC8vIGEgc3RyaW5nIHByZWNlZGVzIHRoZSBuZXh0IG51bWJlciBpbiBiCiAgICAgICAgYnMgPSBiLnNsaWNlKGJpLCBicyk7CiAgICAgICAgaWYgKHNbaV0pIHNbaV0gKz0gYnM7IC8vIGNvYWxlc2NlIHdpdGggcHJldmlvdXMgc3RyaW5nCiAgICAgICAgZWxzZSBzWysraV0gPSBiczsKICAgICAgfQogICAgICBpZiAoKGFtID0gYW1bMF0pID09PSAoYm0gPSBibVswXSkpIHsgLy8gbnVtYmVycyBpbiBhICYgYiBtYXRjaAogICAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJtOyAvLyBjb2FsZXNjZSB3aXRoIHByZXZpb3VzIHN0cmluZwogICAgICAgIGVsc2Ugc1srK2ldID0gYm07CiAgICAgIH0gZWxzZSB7IC8vIGludGVycG9sYXRlIG5vbi1tYXRjaGluZyBudW1iZXJzCiAgICAgICAgc1srK2ldID0gbnVsbDsKICAgICAgICBxLnB1c2goe2k6IGksIHg6IGludGVycG9sYXRlTnVtYmVyKGFtLCBibSl9KTsKICAgICAgfQogICAgICBiaSA9IHJlQi5sYXN0SW5kZXg7CiAgICB9CgogICAgLy8gQWRkIHJlbWFpbnMgb2YgYi4KICAgIGlmIChiaSA8IGIubGVuZ3RoKSB7CiAgICAgIGJzID0gYi5zbGljZShiaSk7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOyAvLyBjb2FsZXNjZSB3aXRoIHByZXZpb3VzIHN0cmluZwogICAgICBlbHNlIHNbKytpXSA9IGJzOwogICAgfQoKICAgIC8vIFNwZWNpYWwgb3B0aW1pemF0aW9uIGZvciBvbmx5IGEgc2luZ2xlIG1hdGNoLgogICAgLy8gT3RoZXJ3aXNlLCBpbnRlcnBvbGF0ZSBlYWNoIG9mIHRoZSBudW1iZXJzIGFuZCByZWpvaW4gdGhlIHN0cmluZy4KICAgIHJldHVybiBzLmxlbmd0aCA8IDIgPyAocVswXQogICAgICAgID8gb25lKHFbMF0ueCkKICAgICAgICA6IHplcm8kMShiKSkKICAgICAgICA6IChiID0gcS5sZW5ndGgsIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG87IGkgPCBiOyArK2kpIHNbKG8gPSBxW2ldKS5pXSA9IG8ueCh0KTsKICAgICAgICAgICAgcmV0dXJuIHMuam9pbigiIik7CiAgICAgICAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGludGVycG9sYXRlKGEsIGIpIHsKICAgIHZhciB0ID0gdHlwZW9mIGIsIGM7CiAgICByZXR1cm4gYiA9PSBudWxsIHx8IHQgPT09ICJib29sZWFuIiA/IGNvbnN0YW50KGIpCiAgICAgICAgOiAodCA9PT0gIm51bWJlciIgPyBpbnRlcnBvbGF0ZU51bWJlcgogICAgICAgIDogdCA9PT0gInN0cmluZyIgPyAoKGMgPSBjb2xvcihiKSkgPyAoYiA9IGMsIGludGVycG9sYXRlUmdiKSA6IHN0cmluZykKICAgICAgICA6IGIgaW5zdGFuY2VvZiBjb2xvciA/IGludGVycG9sYXRlUmdiCiAgICAgICAgOiBiIGluc3RhbmNlb2YgRGF0ZSA/IGRhdGUKICAgICAgICA6IGlzTnVtYmVyQXJyYXkoYikgPyBudW1iZXJBcnJheQogICAgICAgIDogQXJyYXkuaXNBcnJheShiKSA/IGdlbmVyaWNBcnJheQogICAgICAgIDogdHlwZW9mIGIudmFsdWVPZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYi50b1N0cmluZyAhPT0gImZ1bmN0aW9uIiB8fCBpc05hTihiKSA/IG9iamVjdAogICAgICAgIDogaW50ZXJwb2xhdGVOdW1iZXIpKGEsIGIpOwogIH0KCiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVSb3VuZChhLCBiKSB7CiAgICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqICgxIC0gdCkgKyBiICogdCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaHNsKGh1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIGggPSBodWUoKHN0YXJ0ID0gaHNsJDEoc3RhcnQpKS5oLCAoZW5kID0gaHNsJDEoZW5kKSkuaCksCiAgICAgICAgICBzID0gbm9nYW1tYShzdGFydC5zLCBlbmQucyksCiAgICAgICAgICBsID0gbm9nYW1tYShzdGFydC5sLCBlbmQubCksCiAgICAgICAgICBvcGFjaXR5ID0gbm9nYW1tYShzdGFydC5vcGFjaXR5LCBlbmQub3BhY2l0eSk7CiAgICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgICAgc3RhcnQuaCA9IGgodCk7CiAgICAgICAgc3RhcnQucyA9IHModCk7CiAgICAgICAgc3RhcnQubCA9IGwodCk7CiAgICAgICAgc3RhcnQub3BhY2l0eSA9IG9wYWNpdHkodCk7CiAgICAgICAgcmV0dXJuIHN0YXJ0ICsgIiI7CiAgICAgIH07CiAgICB9CiAgfQoKICB2YXIgaW50ZXJwb2xhdGVIc2wgPSBoc2woaHVlKTsKICB2YXIgaHNsTG9uZyA9IGhzbChub2dhbW1hKTsKCiAgZnVuY3Rpb24gbGFiKHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsID0gbm9nYW1tYSgoc3RhcnQgPSBsYWIkMShzdGFydCkpLmwsIChlbmQgPSBsYWIkMShlbmQpKS5sKSwKICAgICAgICBhID0gbm9nYW1tYShzdGFydC5hLCBlbmQuYSksCiAgICAgICAgYiA9IG5vZ2FtbWEoc3RhcnQuYiwgZW5kLmIpLAogICAgICAgIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Lm9wYWNpdHksIGVuZC5vcGFjaXR5KTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHN0YXJ0LmwgPSBsKHQpOwogICAgICBzdGFydC5hID0gYSh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBhc2NlbmRpbmcoYSwgYikgewogICAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogYSA+PSBiID8gMCA6IE5hTjsKICB9CgogIGZ1bmN0aW9uIGRlc2NlbmRpbmcoYSwgYikgewogICAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4KICAgICAgOiBiIDwgYSA/IC0xCiAgICAgIDogYiA+IGEgPyAxCiAgICAgIDogYiA+PSBhID8gMAogICAgICA6IE5hTjsKICB9CgogIGZ1bmN0aW9uIGJpc2VjdG9yKGYpIHsKICAgIGxldCBjb21wYXJlMSwgY29tcGFyZTIsIGRlbHRhOwoKICAgIC8vIElmIGFuIGFjY2Vzc29yIGlzIHNwZWNpZmllZCwgcHJvbW90ZSBpdCB0byBhIGNvbXBhcmF0b3IuIEluIHRoaXMgY2FzZSB3ZQogICAgLy8gY2FuIHRlc3Qgd2hldGhlciB0aGUgc2VhcmNoIHZhbHVlIGlzIChzZWxmLSkgY29tcGFyYWJsZS4gV2UgY2Fu4oCZdCBkbyB0aGlzCiAgICAvLyBmb3IgYSBjb21wYXJhdG9yIChleGNlcHQgZm9yIHNwZWNpZmljLCBrbm93biBjb21wYXJhdG9ycykgYmVjYXVzZSB3ZSBjYW7igJl0CiAgICAvLyB0ZWxsIGlmIHRoZSBjb21wYXJhdG9yIGlzIHN5bW1ldHJpYywgYW5kIGFuIGFzeW1tZXRyaWMgY29tcGFyYXRvciBjYW7igJl0IGJlCiAgICAvLyB1c2VkIHRvIHRlc3Qgd2hldGhlciBhIHNpbmdsZSB2YWx1ZSBpcyBjb21wYXJhYmxlLgogICAgaWYgKGYubGVuZ3RoICE9PSAyKSB7CiAgICAgIGNvbXBhcmUxID0gYXNjZW5kaW5nOwogICAgICBjb21wYXJlMiA9IChkLCB4KSA9PiBhc2NlbmRpbmcoZihkKSwgeCk7CiAgICAgIGRlbHRhID0gKGQsIHgpID0+IGYoZCkgLSB4OwogICAgfSBlbHNlIHsKICAgICAgY29tcGFyZTEgPSBmID09PSBhc2NlbmRpbmcgfHwgZiA9PT0gZGVzY2VuZGluZyA/IGYgOiB6ZXJvOwogICAgICBjb21wYXJlMiA9IGY7CiAgICAgIGRlbHRhID0gZjsKICAgIH0KCiAgICBmdW5jdGlvbiBsZWZ0KGEsIHgsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgICBpZiAobG8gPCBoaSkgewogICAgICAgIGlmIChjb21wYXJlMSh4LCB4KSAhPT0gMCkgcmV0dXJuIGhpOwogICAgICAgIGRvIHsKICAgICAgICAgIGNvbnN0IG1pZCA9IChsbyArIGhpKSA+Pj4gMTsKICAgICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgpIDwgMCkgbG8gPSBtaWQgKyAxOwogICAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgICAgfQogICAgICByZXR1cm4gbG87CiAgICB9CgogICAgZnVuY3Rpb24gcmlnaHQoYSwgeCwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICAgIGlmIChsbyA8IGhpKSB7CiAgICAgICAgaWYgKGNvbXBhcmUxKHgsIHgpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgICAgZG8gewogICAgICAgICAgY29uc3QgbWlkID0gKGxvICsgaGkpID4+PiAxOwogICAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeCkgPD0gMCkgbG8gPSBtaWQgKyAxOwogICAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgICAgfQogICAgICByZXR1cm4gbG87CiAgICB9CgogICAgZnVuY3Rpb24gY2VudGVyKGEsIHgsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgICBjb25zdCBpID0gbGVmdChhLCB4LCBsbywgaGkgLSAxKTsKICAgICAgcmV0dXJuIGkgPiBsbyAmJiBkZWx0YShhW2kgLSAxXSwgeCkgPiAtZGVsdGEoYVtpXSwgeCkgPyBpIC0gMSA6IGk7CiAgICB9CgogICAgcmV0dXJuIHtsZWZ0LCBjZW50ZXIsIHJpZ2h0fTsKICB9CgogIGZ1bmN0aW9uIHplcm8oKSB7CiAgICByZXR1cm4gMDsKICB9CgogIGZ1bmN0aW9uIG51bWJlciQxKHgpIHsKICAgIHJldHVybiB4ID09PSBudWxsID8gTmFOIDogK3g7CiAgfQoKICBjb25zdCBhc2NlbmRpbmdCaXNlY3QgPSBiaXNlY3Rvcihhc2NlbmRpbmcpOwogIGNvbnN0IGJpc2VjdFJpZ2h0ID0gYXNjZW5kaW5nQmlzZWN0LnJpZ2h0OwogIGJpc2VjdG9yKG51bWJlciQxKS5jZW50ZXI7CiAgdmFyIGJpc2VjdCA9IGJpc2VjdFJpZ2h0OwoKICB2YXIgZTEwID0gTWF0aC5zcXJ0KDUwKSwKICAgICAgZTUgPSBNYXRoLnNxcnQoMTApLAogICAgICBlMiA9IE1hdGguc3FydCgyKTsKCiAgZnVuY3Rpb24gdGlja3Moc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICB2YXIgcmV2ZXJzZSwKICAgICAgICBpID0gLTEsCiAgICAgICAgbiwKICAgICAgICB0aWNrcywKICAgICAgICBzdGVwOwoKICAgIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogICAgaWYgKHN0YXJ0ID09PSBzdG9wICYmIGNvdW50ID4gMCkgcmV0dXJuIFtzdGFydF07CiAgICBpZiAocmV2ZXJzZSA9IHN0b3AgPCBzdGFydCkgbiA9IHN0YXJ0LCBzdGFydCA9IHN0b3AsIHN0b3AgPSBuOwogICAgaWYgKChzdGVwID0gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpKSA9PT0gMCB8fCAhaXNGaW5pdGUoc3RlcCkpIHJldHVybiBbXTsKCiAgICBpZiAoc3RlcCA+IDApIHsKICAgICAgbGV0IHIwID0gTWF0aC5yb3VuZChzdGFydCAvIHN0ZXApLCByMSA9IE1hdGgucm91bmQoc3RvcCAvIHN0ZXApOwogICAgICBpZiAocjAgKiBzdGVwIDwgc3RhcnQpICsrcjA7CiAgICAgIGlmIChyMSAqIHN0ZXAgPiBzdG9wKSAtLXIxOwogICAgICB0aWNrcyA9IG5ldyBBcnJheShuID0gcjEgLSByMCArIDEpOwogICAgICB3aGlsZSAoKytpIDwgbikgdGlja3NbaV0gPSAocjAgKyBpKSAqIHN0ZXA7CiAgICB9IGVsc2UgewogICAgICBzdGVwID0gLXN0ZXA7CiAgICAgIGxldCByMCA9IE1hdGgucm91bmQoc3RhcnQgKiBzdGVwKSwgcjEgPSBNYXRoLnJvdW5kKHN0b3AgKiBzdGVwKTsKICAgICAgaWYgKHIwIC8gc3RlcCA8IHN0YXJ0KSArK3IwOwogICAgICBpZiAocjEgLyBzdGVwID4gc3RvcCkgLS1yMTsKICAgICAgdGlja3MgPSBuZXcgQXJyYXkobiA9IHIxIC0gcjAgKyAxKTsKICAgICAgd2hpbGUgKCsraSA8IG4pIHRpY2tzW2ldID0gKHIwICsgaSkgLyBzdGVwOwogICAgfQoKICAgIGlmIChyZXZlcnNlKSB0aWNrcy5yZXZlcnNlKCk7CgogICAgcmV0dXJuIHRpY2tzOwogIH0KCiAgZnVuY3Rpb24gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpIHsKICAgIHZhciBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgwLCBjb3VudCksCiAgICAgICAgcG93ZXIgPSBNYXRoLmZsb29yKE1hdGgubG9nKHN0ZXApIC8gTWF0aC5MTjEwKSwKICAgICAgICBlcnJvciA9IHN0ZXAgLyBNYXRoLnBvdygxMCwgcG93ZXIpOwogICAgcmV0dXJuIHBvd2VyID49IDAKICAgICAgICA/IChlcnJvciA+PSBlMTAgPyAxMCA6IGVycm9yID49IGU1ID8gNSA6IGVycm9yID49IGUyID8gMiA6IDEpICogTWF0aC5wb3coMTAsIHBvd2VyKQogICAgICAgIDogLU1hdGgucG93KDEwLCAtcG93ZXIpIC8gKGVycm9yID49IGUxMCA/IDEwIDogZXJyb3IgPj0gZTUgPyA1IDogZXJyb3IgPj0gZTIgPyAyIDogMSk7CiAgfQoKICBmdW5jdGlvbiB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpIHsKICAgIHZhciBzdGVwMCA9IE1hdGguYWJzKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgwLCBjb3VudCksCiAgICAgICAgc3RlcDEgPSBNYXRoLnBvdygxMCwgTWF0aC5mbG9vcihNYXRoLmxvZyhzdGVwMCkgLyBNYXRoLkxOMTApKSwKICAgICAgICBlcnJvciA9IHN0ZXAwIC8gc3RlcDE7CiAgICBpZiAoZXJyb3IgPj0gZTEwKSBzdGVwMSAqPSAxMDsKICAgIGVsc2UgaWYgKGVycm9yID49IGU1KSBzdGVwMSAqPSA1OwogICAgZWxzZSBpZiAoZXJyb3IgPj0gZTIpIHN0ZXAxICo9IDI7CiAgICByZXR1cm4gc3RvcCA8IHN0YXJ0ID8gLXN0ZXAxIDogc3RlcDE7CiAgfQoKICBmdW5jdGlvbiBpbml0UmFuZ2UoZG9tYWluLCByYW5nZSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogYnJlYWs7CiAgICAgIGNhc2UgMTogdGhpcy5yYW5nZShkb21haW4pOyBicmVhazsKICAgICAgZGVmYXVsdDogdGhpcy5yYW5nZShyYW5nZSkuZG9tYWluKGRvbWFpbik7IGJyZWFrOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBjb25zdGFudHMoeCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4geDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBudW1iZXIoeCkgewogICAgcmV0dXJuICt4OwogIH0KCiAgdmFyIHVuaXQgPSBbMCwgMV07CgogIGZ1bmN0aW9uIGlkZW50aXR5JDEoeCkgewogICAgcmV0dXJuIHg7CiAgfQoKICBmdW5jdGlvbiBub3JtYWxpemUoYSwgYikgewogICAgcmV0dXJuIChiIC09IChhID0gK2EpKQogICAgICAgID8gZnVuY3Rpb24oeCkgeyByZXR1cm4gKHggLSBhKSAvIGI7IH0KICAgICAgICA6IGNvbnN0YW50cyhpc05hTihiKSA/IE5hTiA6IDAuNSk7CiAgfQoKICBmdW5jdGlvbiBjbGFtcGVyKGEsIGIpIHsKICAgIHZhciB0OwogICAgaWYgKGEgPiBiKSB0ID0gYSwgYSA9IGIsIGIgPSB0OwogICAgcmV0dXJuIGZ1bmN0aW9uKHgpIHsgcmV0dXJuIE1hdGgubWF4KGEsIE1hdGgubWluKGIsIHgpKTsgfTsKICB9CgogIC8vIG5vcm1hbGl6ZShhLCBiKSh4KSB0YWtlcyBhIGRvbWFpbiB2YWx1ZSB4IGluIFthLGJdIGFuZCByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHBhcmFtZXRlciB0IGluIFswLDFdLgogIC8vIGludGVycG9sYXRlKGEsIGIpKHQpIHRha2VzIGEgcGFyYW1ldGVyIHQgaW4gWzAsMV0gYW5kIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmFuZ2UgdmFsdWUgeCBpbiBbYSxiXS4KICBmdW5jdGlvbiBiaW1hcChkb21haW4sIHJhbmdlLCBpbnRlcnBvbGF0ZSkgewogICAgdmFyIGQwID0gZG9tYWluWzBdLCBkMSA9IGRvbWFpblsxXSwgcjAgPSByYW5nZVswXSwgcjEgPSByYW5nZVsxXTsKICAgIGlmIChkMSA8IGQwKSBkMCA9IG5vcm1hbGl6ZShkMSwgZDApLCByMCA9IGludGVycG9sYXRlKHIxLCByMCk7CiAgICBlbHNlIGQwID0gbm9ybWFsaXplKGQwLCBkMSksIHIwID0gaW50ZXJwb2xhdGUocjAsIHIxKTsKICAgIHJldHVybiBmdW5jdGlvbih4KSB7IHJldHVybiByMChkMCh4KSk7IH07CiAgfQoKICBmdW5jdGlvbiBwb2x5bWFwKGRvbWFpbiwgcmFuZ2UsIGludGVycG9sYXRlKSB7CiAgICB2YXIgaiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlLmxlbmd0aCkgLSAxLAogICAgICAgIGQgPSBuZXcgQXJyYXkoaiksCiAgICAgICAgciA9IG5ldyBBcnJheShqKSwKICAgICAgICBpID0gLTE7CgogICAgLy8gUmV2ZXJzZSBkZXNjZW5kaW5nIGRvbWFpbnMuCiAgICBpZiAoZG9tYWluW2pdIDwgZG9tYWluWzBdKSB7CiAgICAgIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpLnJldmVyc2UoKTsKICAgICAgcmFuZ2UgPSByYW5nZS5zbGljZSgpLnJldmVyc2UoKTsKICAgIH0KCiAgICB3aGlsZSAoKytpIDwgaikgewogICAgICBkW2ldID0gbm9ybWFsaXplKGRvbWFpbltpXSwgZG9tYWluW2kgKyAxXSk7CiAgICAgIHJbaV0gPSBpbnRlcnBvbGF0ZShyYW5nZVtpXSwgcmFuZ2VbaSArIDFdKTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24oeCkgewogICAgICB2YXIgaSA9IGJpc2VjdChkb21haW4sIHgsIDEsIGopIC0gMTsKICAgICAgcmV0dXJuIHJbaV0oZFtpXSh4KSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY29weShzb3VyY2UsIHRhcmdldCkgewogICAgcmV0dXJuIHRhcmdldAogICAgICAgIC5kb21haW4oc291cmNlLmRvbWFpbigpKQogICAgICAgIC5yYW5nZShzb3VyY2UucmFuZ2UoKSkKICAgICAgICAuaW50ZXJwb2xhdGUoc291cmNlLmludGVycG9sYXRlKCkpCiAgICAgICAgLmNsYW1wKHNvdXJjZS5jbGFtcCgpKQogICAgICAgIC51bmtub3duKHNvdXJjZS51bmtub3duKCkpOwogIH0KCiAgZnVuY3Rpb24gdHJhbnNmb3JtZXIoKSB7CiAgICB2YXIgZG9tYWluID0gdW5pdCwKICAgICAgICByYW5nZSA9IHVuaXQsCiAgICAgICAgaW50ZXJwb2xhdGUkMSA9IGludGVycG9sYXRlLAogICAgICAgIHRyYW5zZm9ybSwKICAgICAgICB1bnRyYW5zZm9ybSwKICAgICAgICB1bmtub3duLAogICAgICAgIGNsYW1wID0gaWRlbnRpdHkkMSwKICAgICAgICBwaWVjZXdpc2UsCiAgICAgICAgb3V0cHV0LAogICAgICAgIGlucHV0OwoKICAgIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICAgIHZhciBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2UubGVuZ3RoKTsKICAgICAgaWYgKGNsYW1wICE9PSBpZGVudGl0eSQxKSBjbGFtcCA9IGNsYW1wZXIoZG9tYWluWzBdLCBkb21haW5bbiAtIDFdKTsKICAgICAgcGllY2V3aXNlID0gbiA+IDIgPyBwb2x5bWFwIDogYmltYXA7CiAgICAgIG91dHB1dCA9IGlucHV0ID0gbnVsbDsKICAgICAgcmV0dXJuIHNjYWxlOwogICAgfQoKICAgIGZ1bmN0aW9uIHNjYWxlKHgpIHsKICAgICAgcmV0dXJuIHggPT0gbnVsbCB8fCBpc05hTih4ID0gK3gpID8gdW5rbm93biA6IChvdXRwdXQgfHwgKG91dHB1dCA9IHBpZWNld2lzZShkb21haW4ubWFwKHRyYW5zZm9ybSksIHJhbmdlLCBpbnRlcnBvbGF0ZSQxKSkpKHRyYW5zZm9ybShjbGFtcCh4KSkpOwogICAgfQoKICAgIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkpIHsKICAgICAgcmV0dXJuIGNsYW1wKHVudHJhbnNmb3JtKChpbnB1dCB8fCAoaW5wdXQgPSBwaWVjZXdpc2UocmFuZ2UsIGRvbWFpbi5tYXAodHJhbnNmb3JtKSwgaW50ZXJwb2xhdGVOdW1iZXIpKSkoeSkpKTsKICAgIH07CgogICAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8sIG51bWJlciksIHJlc2NhbGUoKSkgOiBkb21haW4uc2xpY2UoKTsKICAgIH07CgogICAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlLnNsaWNlKCk7CiAgICB9OwoKICAgIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICAgIHJldHVybiByYW5nZSA9IEFycmF5LmZyb20oXyksIGludGVycG9sYXRlJDEgPSBpbnRlcnBvbGF0ZVJvdW5kLCByZXNjYWxlKCk7CiAgICB9OwoKICAgIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9IF8gPyB0cnVlIDogaWRlbnRpdHkkMSwgcmVzY2FsZSgpKSA6IGNsYW1wICE9PSBpZGVudGl0eSQxOwogICAgfTsKCiAgICBzY2FsZS5pbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uKF8pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdGUkMSA9IF8sIHJlc2NhbGUoKSkgOiBpbnRlcnBvbGF0ZSQxOwogICAgfTsKCiAgICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICAgIH07CgogICAgcmV0dXJuIGZ1bmN0aW9uKHQsIHUpIHsKICAgICAgdHJhbnNmb3JtID0gdCwgdW50cmFuc2Zvcm0gPSB1OwogICAgICByZXR1cm4gcmVzY2FsZSgpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNvbnRpbnVvdXMoKSB7CiAgICByZXR1cm4gdHJhbnNmb3JtZXIoKShpZGVudGl0eSQxLCBpZGVudGl0eSQxKTsKICB9CgogIGZ1bmN0aW9uIGZvcm1hdERlY2ltYWwoeCkgewogICAgcmV0dXJuIE1hdGguYWJzKHggPSBNYXRoLnJvdW5kKHgpKSA+PSAxZTIxCiAgICAgICAgPyB4LnRvTG9jYWxlU3RyaW5nKCJlbiIpLnJlcGxhY2UoLywvZywgIiIpCiAgICAgICAgOiB4LnRvU3RyaW5nKDEwKTsKICB9CgogIC8vIENvbXB1dGVzIHRoZSBkZWNpbWFsIGNvZWZmaWNpZW50IGFuZCBleHBvbmVudCBvZiB0aGUgc3BlY2lmaWVkIG51bWJlciB4IHdpdGgKICAvLyBzaWduaWZpY2FudCBkaWdpdHMgcCwgd2hlcmUgeCBpcyBwb3NpdGl2ZSBhbmQgcCBpcyBpbiBbMSwgMjFdIG9yIHVuZGVmaW5lZC4KICAvLyBGb3IgZXhhbXBsZSwgZm9ybWF0RGVjaW1hbFBhcnRzKDEuMjMpIHJldHVybnMgWyIxMjMiLCAwXS4KICBmdW5jdGlvbiBmb3JtYXREZWNpbWFsUGFydHMoeCwgcCkgewogICAgaWYgKChpID0gKHggPSBwID8geC50b0V4cG9uZW50aWFsKHAgLSAxKSA6IHgudG9FeHBvbmVudGlhbCgpKS5pbmRleE9mKCJlIikpIDwgMCkgcmV0dXJuIG51bGw7IC8vIE5hTiwgwrFJbmZpbml0eQogICAgdmFyIGksIGNvZWZmaWNpZW50ID0geC5zbGljZSgwLCBpKTsKCiAgICAvLyBUaGUgc3RyaW5nIHJldHVybmVkIGJ5IHRvRXhwb25lbnRpYWwgZWl0aGVyIGhhcyB0aGUgZm9ybSBcZFwuXGQrZVstK11cZCsKICAgIC8vIChlLmcuLCAxLjJlKzMpIG9yIHRoZSBmb3JtIFxkZVstK11cZCsgKGUuZy4sIDFlKzMpLgogICAgcmV0dXJuIFsKICAgICAgY29lZmZpY2llbnQubGVuZ3RoID4gMSA/IGNvZWZmaWNpZW50WzBdICsgY29lZmZpY2llbnQuc2xpY2UoMikgOiBjb2VmZmljaWVudCwKICAgICAgK3guc2xpY2UoaSArIDEpCiAgICBdOwogIH0KCiAgZnVuY3Rpb24gZXhwb25lbnQoeCkgewogICAgcmV0dXJuIHggPSBmb3JtYXREZWNpbWFsUGFydHMoTWF0aC5hYnMoeCkpLCB4ID8geFsxXSA6IE5hTjsKICB9CgogIGZ1bmN0aW9uIGZvcm1hdEdyb3VwKGdyb3VwaW5nLCB0aG91c2FuZHMpIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgd2lkdGgpIHsKICAgICAgdmFyIGkgPSB2YWx1ZS5sZW5ndGgsCiAgICAgICAgICB0ID0gW10sCiAgICAgICAgICBqID0gMCwKICAgICAgICAgIGcgPSBncm91cGluZ1swXSwKICAgICAgICAgIGxlbmd0aCA9IDA7CgogICAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgICBpZiAobGVuZ3RoICsgZyArIDEgPiB3aWR0aCkgZyA9IE1hdGgubWF4KDEsIHdpZHRoIC0gbGVuZ3RoKTsKICAgICAgICB0LnB1c2godmFsdWUuc3Vic3RyaW5nKGkgLT0gZywgaSArIGcpKTsKICAgICAgICBpZiAoKGxlbmd0aCArPSBnICsgMSkgPiB3aWR0aCkgYnJlYWs7CiAgICAgICAgZyA9IGdyb3VwaW5nW2ogPSAoaiArIDEpICUgZ3JvdXBpbmcubGVuZ3RoXTsKICAgICAgfQoKICAgICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4odGhvdXNhbmRzKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBmb3JtYXROdW1lcmFscyhudW1lcmFscykgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9bMC05XS9nLCBmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuIG51bWVyYWxzWytpXTsKICAgICAgfSk7CiAgICB9OwogIH0KCiAgLy8gW1tmaWxsXWFsaWduXVtzaWduXVtzeW1ib2xdWzBdW3dpZHRoXVssXVsucHJlY2lzaW9uXVt+XVt0eXBlXQogIHZhciByZSA9IC9eKD86KC4pPyhbPD49Xl0pKT8oWytcLSggXSk/KFskI10pPygwKT8oXGQrKT8oLCk/KFwuXGQrKT8ofik/KFthLXolXSk/JC9pOwoKICBmdW5jdGlvbiBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgICBpZiAoIShtYXRjaCA9IHJlLmV4ZWMoc3BlY2lmaWVyKSkpIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCBmb3JtYXQ6ICIgKyBzcGVjaWZpZXIpOwogICAgdmFyIG1hdGNoOwogICAgcmV0dXJuIG5ldyBGb3JtYXRTcGVjaWZpZXIoewogICAgICBmaWxsOiBtYXRjaFsxXSwKICAgICAgYWxpZ246IG1hdGNoWzJdLAogICAgICBzaWduOiBtYXRjaFszXSwKICAgICAgc3ltYm9sOiBtYXRjaFs0XSwKICAgICAgemVybzogbWF0Y2hbNV0sCiAgICAgIHdpZHRoOiBtYXRjaFs2XSwKICAgICAgY29tbWE6IG1hdGNoWzddLAogICAgICBwcmVjaXNpb246IG1hdGNoWzhdICYmIG1hdGNoWzhdLnNsaWNlKDEpLAogICAgICB0cmltOiBtYXRjaFs5XSwKICAgICAgdHlwZTogbWF0Y2hbMTBdCiAgICB9KTsKICB9CgogIGZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUgPSBGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlOyAvLyBpbnN0YW5jZW9mCgogIGZ1bmN0aW9uIEZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpIHsKICAgIHRoaXMuZmlsbCA9IHNwZWNpZmllci5maWxsID09PSB1bmRlZmluZWQgPyAiICIgOiBzcGVjaWZpZXIuZmlsbCArICIiOwogICAgdGhpcy5hbGlnbiA9IHNwZWNpZmllci5hbGlnbiA9PT0gdW5kZWZpbmVkID8gIj4iIDogc3BlY2lmaWVyLmFsaWduICsgIiI7CiAgICB0aGlzLnNpZ24gPSBzcGVjaWZpZXIuc2lnbiA9PT0gdW5kZWZpbmVkID8gIi0iIDogc3BlY2lmaWVyLnNpZ24gKyAiIjsKICAgIHRoaXMuc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCA9PT0gdW5kZWZpbmVkID8gIiIgOiBzcGVjaWZpZXIuc3ltYm9sICsgIiI7CiAgICB0aGlzLnplcm8gPSAhIXNwZWNpZmllci56ZXJvOwogICAgdGhpcy53aWR0aCA9IHNwZWNpZmllci53aWR0aCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogK3NwZWNpZmllci53aWR0aDsKICAgIHRoaXMuY29tbWEgPSAhIXNwZWNpZmllci5jb21tYTsKICAgIHRoaXMucHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogK3NwZWNpZmllci5wcmVjaXNpb247CiAgICB0aGlzLnRyaW0gPSAhIXNwZWNpZmllci50cmltOwogICAgdGhpcy50eXBlID0gc3BlY2lmaWVyLnR5cGUgPT09IHVuZGVmaW5lZCA/ICIiIDogc3BlY2lmaWVyLnR5cGUgKyAiIjsKICB9CgogIEZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmZpbGwKICAgICAgICArIHRoaXMuYWxpZ24KICAgICAgICArIHRoaXMuc2lnbgogICAgICAgICsgdGhpcy5zeW1ib2wKICAgICAgICArICh0aGlzLnplcm8gPyAiMCIgOiAiIikKICAgICAgICArICh0aGlzLndpZHRoID09PSB1bmRlZmluZWQgPyAiIiA6IE1hdGgubWF4KDEsIHRoaXMud2lkdGggfCAwKSkKICAgICAgICArICh0aGlzLmNvbW1hID8gIiwiIDogIiIpCiAgICAgICAgKyAodGhpcy5wcmVjaXNpb24gPT09IHVuZGVmaW5lZCA/ICIiIDogIi4iICsgTWF0aC5tYXgoMCwgdGhpcy5wcmVjaXNpb24gfCAwKSkKICAgICAgICArICh0aGlzLnRyaW0gPyAifiIgOiAiIikKICAgICAgICArIHRoaXMudHlwZTsKICB9OwoKICAvLyBUcmltcyBpbnNpZ25pZmljYW50IHplcm9zLCBlLmcuLCByZXBsYWNlcyAxLjIwMDBrIHdpdGggMS4yay4KICBmdW5jdGlvbiBmb3JtYXRUcmltKHMpIHsKICAgIG91dDogZm9yICh2YXIgbiA9IHMubGVuZ3RoLCBpID0gMSwgaTAgPSAtMSwgaTE7IGkgPCBuOyArK2kpIHsKICAgICAgc3dpdGNoIChzW2ldKSB7CiAgICAgICAgY2FzZSAiLiI6IGkwID0gaTEgPSBpOyBicmVhazsKICAgICAgICBjYXNlICIwIjogaWYgKGkwID09PSAwKSBpMCA9IGk7IGkxID0gaTsgYnJlYWs7CiAgICAgICAgZGVmYXVsdDogaWYgKCErc1tpXSkgYnJlYWsgb3V0OyBpZiAoaTAgPiAwKSBpMCA9IDA7IGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaTAgPiAwID8gcy5zbGljZSgwLCBpMCkgKyBzLnNsaWNlKGkxICsgMSkgOiBzOwogIH0KCiAgdmFyIHByZWZpeEV4cG9uZW50OwoKICBmdW5jdGlvbiBmb3JtYXRQcmVmaXhBdXRvKHgsIHApIHsKICAgIHZhciBkID0gZm9ybWF0RGVjaW1hbFBhcnRzKHgsIHApOwogICAgaWYgKCFkKSByZXR1cm4geCArICIiOwogICAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwKICAgICAgICBleHBvbmVudCA9IGRbMV0sCiAgICAgICAgaSA9IGV4cG9uZW50IC0gKHByZWZpeEV4cG9uZW50ID0gTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnQgLyAzKSkpICogMykgKyAxLAogICAgICAgIG4gPSBjb2VmZmljaWVudC5sZW5ndGg7CiAgICByZXR1cm4gaSA9PT0gbiA/IGNvZWZmaWNpZW50CiAgICAgICAgOiBpID4gbiA/IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGkgLSBuICsgMSkuam9pbigiMCIpCiAgICAgICAgOiBpID4gMCA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGkpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoaSkKICAgICAgICA6ICIwLiIgKyBuZXcgQXJyYXkoMSAtIGkpLmpvaW4oIjAiKSArIGZvcm1hdERlY2ltYWxQYXJ0cyh4LCBNYXRoLm1heCgwLCBwICsgaSAtIDEpKVswXTsgLy8gbGVzcyB0aGFuIDF5IQogIH0KCiAgZnVuY3Rpb24gZm9ybWF0Um91bmRlZCh4LCBwKSB7CiAgICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4LCBwKTsKICAgIGlmICghZCkgcmV0dXJuIHggKyAiIjsKICAgIHZhciBjb2VmZmljaWVudCA9IGRbMF0sCiAgICAgICAgZXhwb25lbnQgPSBkWzFdOwogICAgcmV0dXJuIGV4cG9uZW50IDwgMCA/ICIwLiIgKyBuZXcgQXJyYXkoLWV4cG9uZW50KS5qb2luKCIwIikgKyBjb2VmZmljaWVudAogICAgICAgIDogY29lZmZpY2llbnQubGVuZ3RoID4gZXhwb25lbnQgKyAxID8gY29lZmZpY2llbnQuc2xpY2UoMCwgZXhwb25lbnQgKyAxKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGV4cG9uZW50ICsgMSkKICAgICAgICA6IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGV4cG9uZW50IC0gY29lZmZpY2llbnQubGVuZ3RoICsgMikuam9pbigiMCIpOwogIH0KCiAgdmFyIGZvcm1hdFR5cGVzID0gewogICAgIiUiOiAoeCwgcCkgPT4gKHggKiAxMDApLnRvRml4ZWQocCksCiAgICAiYiI6ICh4KSA9PiBNYXRoLnJvdW5kKHgpLnRvU3RyaW5nKDIpLAogICAgImMiOiAoeCkgPT4geCArICIiLAogICAgImQiOiBmb3JtYXREZWNpbWFsLAogICAgImUiOiAoeCwgcCkgPT4geC50b0V4cG9uZW50aWFsKHApLAogICAgImYiOiAoeCwgcCkgPT4geC50b0ZpeGVkKHApLAogICAgImciOiAoeCwgcCkgPT4geC50b1ByZWNpc2lvbihwKSwKICAgICJvIjogKHgpID0+IE1hdGgucm91bmQoeCkudG9TdHJpbmcoOCksCiAgICAicCI6ICh4LCBwKSA9PiBmb3JtYXRSb3VuZGVkKHggKiAxMDAsIHApLAogICAgInIiOiBmb3JtYXRSb3VuZGVkLAogICAgInMiOiBmb3JtYXRQcmVmaXhBdXRvLAogICAgIlgiOiAoeCkgPT4gTWF0aC5yb3VuZCh4KS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKSwKICAgICJ4IjogKHgpID0+IE1hdGgucm91bmQoeCkudG9TdHJpbmcoMTYpCiAgfTsKCiAgZnVuY3Rpb24gaWRlbnRpdHkoeCkgewogICAgcmV0dXJuIHg7CiAgfQoKICB2YXIgbWFwID0gQXJyYXkucHJvdG90eXBlLm1hcCwKICAgICAgcHJlZml4ZXMgPSBbInkiLCJ6IiwiYSIsImYiLCJwIiwibiIsIsK1IiwibSIsIiIsImsiLCJNIiwiRyIsIlQiLCJQIiwiRSIsIloiLCJZIl07CgogIGZ1bmN0aW9uIGZvcm1hdExvY2FsZShsb2NhbGUpIHsKICAgIHZhciBncm91cCA9IGxvY2FsZS5ncm91cGluZyA9PT0gdW5kZWZpbmVkIHx8IGxvY2FsZS50aG91c2FuZHMgPT09IHVuZGVmaW5lZCA/IGlkZW50aXR5IDogZm9ybWF0R3JvdXAobWFwLmNhbGwobG9jYWxlLmdyb3VwaW5nLCBOdW1iZXIpLCBsb2NhbGUudGhvdXNhbmRzICsgIiIpLAogICAgICAgIGN1cnJlbmN5UHJlZml4ID0gbG9jYWxlLmN1cnJlbmN5ID09PSB1bmRlZmluZWQgPyAiIiA6IGxvY2FsZS5jdXJyZW5jeVswXSArICIiLAogICAgICAgIGN1cnJlbmN5U3VmZml4ID0gbG9jYWxlLmN1cnJlbmN5ID09PSB1bmRlZmluZWQgPyAiIiA6IGxvY2FsZS5jdXJyZW5jeVsxXSArICIiLAogICAgICAgIGRlY2ltYWwgPSBsb2NhbGUuZGVjaW1hbCA9PT0gdW5kZWZpbmVkID8gIi4iIDogbG9jYWxlLmRlY2ltYWwgKyAiIiwKICAgICAgICBudW1lcmFscyA9IGxvY2FsZS5udW1lcmFscyA9PT0gdW5kZWZpbmVkID8gaWRlbnRpdHkgOiBmb3JtYXROdW1lcmFscyhtYXAuY2FsbChsb2NhbGUubnVtZXJhbHMsIFN0cmluZykpLAogICAgICAgIHBlcmNlbnQgPSBsb2NhbGUucGVyY2VudCA9PT0gdW5kZWZpbmVkID8gIiUiIDogbG9jYWxlLnBlcmNlbnQgKyAiIiwKICAgICAgICBtaW51cyA9IGxvY2FsZS5taW51cyA9PT0gdW5kZWZpbmVkID8gIuKIkiIgOiBsb2NhbGUubWludXMgKyAiIiwKICAgICAgICBuYW4gPSBsb2NhbGUubmFuID09PSB1bmRlZmluZWQgPyAiTmFOIiA6IGxvY2FsZS5uYW4gKyAiIjsKCiAgICBmdW5jdGlvbiBuZXdGb3JtYXQoc3BlY2lmaWVyKSB7CiAgICAgIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpOwoKICAgICAgdmFyIGZpbGwgPSBzcGVjaWZpZXIuZmlsbCwKICAgICAgICAgIGFsaWduID0gc3BlY2lmaWVyLmFsaWduLAogICAgICAgICAgc2lnbiA9IHNwZWNpZmllci5zaWduLAogICAgICAgICAgc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCwKICAgICAgICAgIHplcm8gPSBzcGVjaWZpZXIuemVybywKICAgICAgICAgIHdpZHRoID0gc3BlY2lmaWVyLndpZHRoLAogICAgICAgICAgY29tbWEgPSBzcGVjaWZpZXIuY29tbWEsCiAgICAgICAgICBwcmVjaXNpb24gPSBzcGVjaWZpZXIucHJlY2lzaW9uLAogICAgICAgICAgdHJpbSA9IHNwZWNpZmllci50cmltLAogICAgICAgICAgdHlwZSA9IHNwZWNpZmllci50eXBlOwoKICAgICAgLy8gVGhlICJuIiB0eXBlIGlzIGFuIGFsaWFzIGZvciAiLGciLgogICAgICBpZiAodHlwZSA9PT0gIm4iKSBjb21tYSA9IHRydWUsIHR5cGUgPSAiZyI7CgogICAgICAvLyBUaGUgIiIgdHlwZSwgYW5kIGFueSBpbnZhbGlkIHR5cGUsIGlzIGFuIGFsaWFzIGZvciAiLjEyfmciLgogICAgICBlbHNlIGlmICghZm9ybWF0VHlwZXNbdHlwZV0pIHByZWNpc2lvbiA9PT0gdW5kZWZpbmVkICYmIChwcmVjaXNpb24gPSAxMiksIHRyaW0gPSB0cnVlLCB0eXBlID0gImciOwoKICAgICAgLy8gSWYgemVybyBmaWxsIGlzIHNwZWNpZmllZCwgcGFkZGluZyBnb2VzIGFmdGVyIHNpZ24gYW5kIGJlZm9yZSBkaWdpdHMuCiAgICAgIGlmICh6ZXJvIHx8IChmaWxsID09PSAiMCIgJiYgYWxpZ24gPT09ICI9IikpIHplcm8gPSB0cnVlLCBmaWxsID0gIjAiLCBhbGlnbiA9ICI9IjsKCiAgICAgIC8vIENvbXB1dGUgdGhlIHByZWZpeCBhbmQgc3VmZml4LgogICAgICAvLyBGb3IgU0ktcHJlZml4LCB0aGUgc3VmZml4IGlzIGxhemlseSBjb21wdXRlZC4KICAgICAgdmFyIHByZWZpeCA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lQcmVmaXggOiBzeW1ib2wgPT09ICIjIiAmJiAvW2JveFhdLy50ZXN0KHR5cGUpID8gIjAiICsgdHlwZS50b0xvd2VyQ2FzZSgpIDogIiIsCiAgICAgICAgICBzdWZmaXggPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5U3VmZml4IDogL1slcF0vLnRlc3QodHlwZSkgPyBwZXJjZW50IDogIiI7CgogICAgICAvLyBXaGF0IGZvcm1hdCBmdW5jdGlvbiBzaG91bGQgd2UgdXNlPwogICAgICAvLyBJcyB0aGlzIGFuIGludGVnZXIgdHlwZT8KICAgICAgLy8gQ2FuIHRoaXMgdHlwZSBnZW5lcmF0ZSBleHBvbmVudGlhbCBub3RhdGlvbj8KICAgICAgdmFyIGZvcm1hdFR5cGUgPSBmb3JtYXRUeXBlc1t0eXBlXSwKICAgICAgICAgIG1heWJlU3VmZml4ID0gL1tkZWZncHJzJV0vLnRlc3QodHlwZSk7CgogICAgICAvLyBTZXQgdGhlIGRlZmF1bHQgcHJlY2lzaW9uIGlmIG5vdCBzcGVjaWZpZWQsCiAgICAgIC8vIG9yIGNsYW1wIHRoZSBzcGVjaWZpZWQgcHJlY2lzaW9uIHRvIHRoZSBzdXBwb3J0ZWQgcmFuZ2UuCiAgICAgIC8vIEZvciBzaWduaWZpY2FudCBwcmVjaXNpb24sIGl0IG11c3QgYmUgaW4gWzEsIDIxXS4KICAgICAgLy8gRm9yIGZpeGVkIHByZWNpc2lvbiwgaXQgbXVzdCBiZSBpbiBbMCwgMjBdLgogICAgICBwcmVjaXNpb24gPSBwcmVjaXNpb24gPT09IHVuZGVmaW5lZCA/IDYKICAgICAgICAgIDogL1tncHJzXS8udGVzdCh0eXBlKSA/IE1hdGgubWF4KDEsIE1hdGgubWluKDIxLCBwcmVjaXNpb24pKQogICAgICAgICAgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigyMCwgcHJlY2lzaW9uKSk7CgogICAgICBmdW5jdGlvbiBmb3JtYXQodmFsdWUpIHsKICAgICAgICB2YXIgdmFsdWVQcmVmaXggPSBwcmVmaXgsCiAgICAgICAgICAgIHZhbHVlU3VmZml4ID0gc3VmZml4LAogICAgICAgICAgICBpLCBuLCBjOwoKICAgICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgICB2YWx1ZVN1ZmZpeCA9IGZvcm1hdFR5cGUodmFsdWUpICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICB2YWx1ZSA9ICIiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWx1ZSA9ICt2YWx1ZTsKCiAgICAgICAgICAvLyBEZXRlcm1pbmUgdGhlIHNpZ24uIC0wIGlzIG5vdCBsZXNzIHRoYW4gMCwgYnV0IDEgLyAtMCBpcyEKICAgICAgICAgIHZhciB2YWx1ZU5lZ2F0aXZlID0gdmFsdWUgPCAwIHx8IDEgLyB2YWx1ZSA8IDA7CgogICAgICAgICAgLy8gUGVyZm9ybSB0aGUgaW5pdGlhbCBmb3JtYXR0aW5nLgogICAgICAgICAgdmFsdWUgPSBpc05hTih2YWx1ZSkgPyBuYW4gOiBmb3JtYXRUeXBlKE1hdGguYWJzKHZhbHVlKSwgcHJlY2lzaW9uKTsKCiAgICAgICAgICAvLyBUcmltIGluc2lnbmlmaWNhbnQgemVyb3MuCiAgICAgICAgICBpZiAodHJpbSkgdmFsdWUgPSBmb3JtYXRUcmltKHZhbHVlKTsKCiAgICAgICAgICAvLyBJZiBhIG5lZ2F0aXZlIHZhbHVlIHJvdW5kcyB0byB6ZXJvIGFmdGVyIGZvcm1hdHRpbmcsIGFuZCBubyBleHBsaWNpdCBwb3NpdGl2ZSBzaWduIGlzIHJlcXVlc3RlZCwgaGlkZSB0aGUgc2lnbi4KICAgICAgICAgIGlmICh2YWx1ZU5lZ2F0aXZlICYmICt2YWx1ZSA9PT0gMCAmJiBzaWduICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKCiAgICAgICAgICAvLyBDb21wdXRlIHRoZSBwcmVmaXggYW5kIHN1ZmZpeC4KICAgICAgICAgIHZhbHVlUHJlZml4ID0gKHZhbHVlTmVnYXRpdmUgPyAoc2lnbiA9PT0gIigiID8gc2lnbiA6IG1pbnVzKSA6IHNpZ24gPT09ICItIiB8fCBzaWduID09PSAiKCIgPyAiIiA6IHNpZ24pICsgdmFsdWVQcmVmaXg7CiAgICAgICAgICB2YWx1ZVN1ZmZpeCA9ICh0eXBlID09PSAicyIgPyBwcmVmaXhlc1s4ICsgcHJlZml4RXhwb25lbnQgLyAzXSA6ICIiKSArIHZhbHVlU3VmZml4ICsgKHZhbHVlTmVnYXRpdmUgJiYgc2lnbiA9PT0gIigiID8gIikiIDogIiIpOwoKICAgICAgICAgIC8vIEJyZWFrIHRoZSBmb3JtYXR0ZWQgdmFsdWUgaW50byB0aGUgaW50ZWdlciDigJx2YWx1ZeKAnSBwYXJ0IHRoYXQgY2FuIGJlCiAgICAgICAgICAvLyBncm91cGVkLCBhbmQgZnJhY3Rpb25hbCBvciBleHBvbmVudGlhbCDigJxzdWZmaXjigJ0gcGFydCB0aGF0IGlzIG5vdC4KICAgICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgICBpID0gLTEsIG4gPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgICAgICAgaWYgKGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpLCA0OCA+IGMgfHwgYyA+IDU3KSB7CiAgICAgICAgICAgICAgICB2YWx1ZVN1ZmZpeCA9IChjID09PSA0NiA/IGRlY2ltYWwgKyB2YWx1ZS5zbGljZShpICsgMSkgOiB2YWx1ZS5zbGljZShpKSkgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIElmIHRoZSBmaWxsIGNoYXJhY3RlciBpcyBub3QgIjAiLCBncm91cGluZyBpcyBhcHBsaWVkIGJlZm9yZSBwYWRkaW5nLgogICAgICAgIGlmIChjb21tYSAmJiAhemVybykgdmFsdWUgPSBncm91cCh2YWx1ZSwgSW5maW5pdHkpOwoKICAgICAgICAvLyBDb21wdXRlIHRoZSBwYWRkaW5nLgogICAgICAgIHZhciBsZW5ndGggPSB2YWx1ZVByZWZpeC5sZW5ndGggKyB2YWx1ZS5sZW5ndGggKyB2YWx1ZVN1ZmZpeC5sZW5ndGgsCiAgICAgICAgICAgIHBhZGRpbmcgPSBsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgOiAiIjsKCiAgICAgICAgLy8gSWYgdGhlIGZpbGwgY2hhcmFjdGVyIGlzICIwIiwgZ3JvdXBpbmcgaXMgYXBwbGllZCBhZnRlciBwYWRkaW5nLgogICAgICAgIGlmIChjb21tYSAmJiB6ZXJvKSB2YWx1ZSA9IGdyb3VwKHBhZGRpbmcgKyB2YWx1ZSwgcGFkZGluZy5sZW5ndGggPyB3aWR0aCAtIHZhbHVlU3VmZml4Lmxlbmd0aCA6IEluZmluaXR5KSwgcGFkZGluZyA9ICIiOwoKICAgICAgICAvLyBSZWNvbnN0cnVjdCB0aGUgZmluYWwgb3V0cHV0IGJhc2VkIG9uIHRoZSBkZXNpcmVkIGFsaWdubWVudC4KICAgICAgICBzd2l0Y2ggKGFsaWduKSB7CiAgICAgICAgICBjYXNlICI8IjogdmFsdWUgPSB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nOyBicmVhazsKICAgICAgICAgIGNhc2UgIj0iOiB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgcGFkZGluZyArIHZhbHVlICsgdmFsdWVTdWZmaXg7IGJyZWFrOwogICAgICAgICAgY2FzZSAiXiI6IHZhbHVlID0gcGFkZGluZy5zbGljZSgwLCBsZW5ndGggPSBwYWRkaW5nLmxlbmd0aCA+PiAxKSArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmcuc2xpY2UobGVuZ3RoKTsgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OiB2YWx1ZSA9IHBhZGRpbmcgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXg7IGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bWVyYWxzKHZhbHVlKTsKICAgICAgfQoKICAgICAgZm9ybWF0LnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllciArICIiOwogICAgICB9OwoKICAgICAgcmV0dXJuIGZvcm1hdDsKICAgIH0KCiAgICBmdW5jdGlvbiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSkgewogICAgICB2YXIgZiA9IG5ld0Zvcm1hdCgoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciksIHNwZWNpZmllci50eXBlID0gImYiLCBzcGVjaWZpZXIpKSwKICAgICAgICAgIGUgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudCh2YWx1ZSkgLyAzKSkpICogMywKICAgICAgICAgIGsgPSBNYXRoLnBvdygxMCwgLWUpLAogICAgICAgICAgcHJlZml4ID0gcHJlZml4ZXNbOCArIGUgLyAzXTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGYoayAqIHZhbHVlKSArIHByZWZpeDsKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmb3JtYXQ6IG5ld0Zvcm1hdCwKICAgICAgZm9ybWF0UHJlZml4OiBmb3JtYXRQcmVmaXgKICAgIH07CiAgfQoKICB2YXIgbG9jYWxlOwogIHZhciBmb3JtYXQ7CiAgdmFyIGZvcm1hdFByZWZpeDsKCiAgZGVmYXVsdExvY2FsZSh7CiAgICB0aG91c2FuZHM6ICIsIiwKICAgIGdyb3VwaW5nOiBbM10sCiAgICBjdXJyZW5jeTogWyIkIiwgIiJdCiAgfSk7CgogIGZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUoZGVmaW5pdGlvbikgewogICAgbG9jYWxlID0gZm9ybWF0TG9jYWxlKGRlZmluaXRpb24pOwogICAgZm9ybWF0ID0gbG9jYWxlLmZvcm1hdDsKICAgIGZvcm1hdFByZWZpeCA9IGxvY2FsZS5mb3JtYXRQcmVmaXg7CiAgICByZXR1cm4gbG9jYWxlOwogIH0KCiAgZnVuY3Rpb24gcHJlY2lzaW9uRml4ZWQoc3RlcCkgewogICAgcmV0dXJuIE1hdGgubWF4KDAsIC1leHBvbmVudChNYXRoLmFicyhzdGVwKSkpOwogIH0KCiAgZnVuY3Rpb24gcHJlY2lzaW9uUHJlZml4KHN0ZXAsIHZhbHVlKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnQodmFsdWUpIC8gMykpKSAqIDMgLSBleHBvbmVudChNYXRoLmFicyhzdGVwKSkpOwogIH0KCiAgZnVuY3Rpb24gcHJlY2lzaW9uUm91bmQoc3RlcCwgbWF4KSB7CiAgICBzdGVwID0gTWF0aC5hYnMoc3RlcCksIG1heCA9IE1hdGguYWJzKG1heCkgLSBzdGVwOwogICAgcmV0dXJuIE1hdGgubWF4KDAsIGV4cG9uZW50KG1heCkgLSBleHBvbmVudChzdGVwKSkgKyAxOwogIH0KCiAgZnVuY3Rpb24gdGlja0Zvcm1hdChzdGFydCwgc3RvcCwgY291bnQsIHNwZWNpZmllcikgewogICAgdmFyIHN0ZXAgPSB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLAogICAgICAgIHByZWNpc2lvbjsKICAgIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIgPT0gbnVsbCA/ICIsZiIgOiBzcGVjaWZpZXIpOwogICAgc3dpdGNoIChzcGVjaWZpZXIudHlwZSkgewogICAgICBjYXNlICJzIjogewogICAgICAgIHZhciB2YWx1ZSA9IE1hdGgubWF4KE1hdGguYWJzKHN0YXJ0KSwgTWF0aC5hYnMoc3RvcCkpOwogICAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblByZWZpeChzdGVwLCB2YWx1ZSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uOwogICAgICAgIHJldHVybiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgY2FzZSAiIjoKICAgICAgY2FzZSAiZSI6CiAgICAgIGNhc2UgImciOgogICAgICBjYXNlICJwIjoKICAgICAgY2FzZSAiciI6IHsKICAgICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25Sb3VuZChzdGVwLCBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiZSIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgImYiOgogICAgICBjYXNlICIlIjogewogICAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvbkZpeGVkKHN0ZXApKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbiAtIChzcGVjaWZpZXIudHlwZSA9PT0gIiUiKSAqIDI7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmb3JtYXQoc3BlY2lmaWVyKTsKICB9CgogIGZ1bmN0aW9uIGxpbmVhcmlzaChzY2FsZSkgewogICAgdmFyIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKCiAgICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICAgIHZhciBkID0gZG9tYWluKCk7CiAgICAgIHJldHVybiB0aWNrcyhkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50KTsKICAgIH07CgogICAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgICAgdmFyIGQgPSBkb21haW4oKTsKICAgICAgcmV0dXJuIHRpY2tGb3JtYXQoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudCA9PSBudWxsID8gMTAgOiBjb3VudCwgc3BlY2lmaWVyKTsKICAgIH07CgogICAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICAgIGlmIChjb3VudCA9PSBudWxsKSBjb3VudCA9IDEwOwoKICAgICAgdmFyIGQgPSBkb21haW4oKTsKICAgICAgdmFyIGkwID0gMDsKICAgICAgdmFyIGkxID0gZC5sZW5ndGggLSAxOwogICAgICB2YXIgc3RhcnQgPSBkW2kwXTsKICAgICAgdmFyIHN0b3AgPSBkW2kxXTsKICAgICAgdmFyIHByZXN0ZXA7CiAgICAgIHZhciBzdGVwOwogICAgICB2YXIgbWF4SXRlciA9IDEwOwoKICAgICAgaWYgKHN0b3AgPCBzdGFydCkgewogICAgICAgIHN0ZXAgPSBzdGFydCwgc3RhcnQgPSBzdG9wLCBzdG9wID0gc3RlcDsKICAgICAgICBzdGVwID0gaTAsIGkwID0gaTEsIGkxID0gc3RlcDsKICAgICAgfQogICAgICAKICAgICAgd2hpbGUgKG1heEl0ZXItLSA+IDApIHsKICAgICAgICBzdGVwID0gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpOwogICAgICAgIGlmIChzdGVwID09PSBwcmVzdGVwKSB7CiAgICAgICAgICBkW2kwXSA9IHN0YXJ0OwogICAgICAgICAgZFtpMV0gPSBzdG9wOwogICAgICAgICAgcmV0dXJuIGRvbWFpbihkKTsKICAgICAgICB9IGVsc2UgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgICBzdGFydCA9IE1hdGguZmxvb3Ioc3RhcnQgLyBzdGVwKSAqIHN0ZXA7CiAgICAgICAgICBzdG9wID0gTWF0aC5jZWlsKHN0b3AgLyBzdGVwKSAqIHN0ZXA7CiAgICAgICAgfSBlbHNlIGlmIChzdGVwIDwgMCkgewogICAgICAgICAgc3RhcnQgPSBNYXRoLmNlaWwoc3RhcnQgKiBzdGVwKSAvIHN0ZXA7CiAgICAgICAgICBzdG9wID0gTWF0aC5mbG9vcihzdG9wICogc3RlcCkgLyBzdGVwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcHJlc3RlcCA9IHN0ZXA7CiAgICAgIH0KCiAgICAgIHJldHVybiBzY2FsZTsKICAgIH07CgogICAgcmV0dXJuIHNjYWxlOwogIH0KCiAgZnVuY3Rpb24gbGluZWFyKCkgewogICAgdmFyIHNjYWxlID0gY29udGludW91cygpOwoKICAgIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGNvcHkoc2NhbGUsIGxpbmVhcigpKTsKICAgIH07CgogICAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwoKICAgIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwogIH0KCiAgY29uc3QgaW50ZXJwb2xhdGVGYWN0b3J5cyA9IHsNCiAgICAgICdyZ2InOiBpbnRlcnBvbGF0ZVJnYiwNCiAgICAgICdoc2wnOiBpbnRlcnBvbGF0ZUhzbCwNCiAgICAgICdoc2xMb25nJzogaHNsTG9uZywNCiAgICAgICdsYWInOiBsYWINCiAgfTsNCiAgZnVuY3Rpb24gZGVjaW1hbDJyZ2IobnVtYmVyKSB7DQogICAgICByZXR1cm4gTWF0aC5yb3VuZChudW1iZXIgKiAyNTUpOw0KICB9DQogIGZ1bmN0aW9uIGdldFJhbmdlKGJhbmRzLCBvcHRzKSB7DQogICAgICBjb25zdCBtaW4gPSBvcHRzPy5taW4gPz8gK2JhbmRzWyhvcHRzPy5iYW5kID8/IDEpIC0gMV0ubWluOw0KICAgICAgY29uc3QgbWF4ID0gb3B0cz8ubWF4ID8/ICtiYW5kc1sob3B0cz8uYmFuZCA/PyAxKSAtIDFdLm1heDsNCiAgICAgIGNvbnN0IHJhbmdlID0gbWF4IC0gbWluOw0KICAgICAgcmV0dXJuIHsgbWluLCBtYXgsIHJhbmdlIH07DQogIH0NCiAgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVJbWFnZShkYXRhLCBvcHRzKSB7DQogICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIHJlbmRlck9wdGlvbnMsIGJhbmRzLCBub0RhdGEgfSA9IG9wdHM7DQogICAgICBjb25zdCBpbWFnZURhdGEgPSBuZXcgVWludDhDbGFtcGVkQXJyYXkod2lkdGggKiBoZWlnaHQgKiA0KTsNCiAgICAgIGNvbnN0IHsgciwgZywgYiwgZmlsbCB9ID0gcmVuZGVyT3B0aW9ucyA/PyB7fTsNCiAgICAgIGNvbnN0IHJhbmdlcyA9IFtyLCBnLCBiXS5tYXAoaXRlbSA9PiBnZXRSYW5nZShiYW5kcywgaXRlbSkpOw0KICAgICAgY29uc3QgcmVkRGF0YSA9IGRhdGFbKHI/LmJhbmQgPz8gMSkgLSAxXTsNCiAgICAgIGNvbnN0IGdyZWVuRGF0YSA9IGRhdGFbKGc/LmJhbmQgPz8gMSkgLSAxXTsNCiAgICAgIGNvbnN0IGJsdWVEYXRhID0gZGF0YVsoYj8uYmFuZCA/PyAxKSAtIDFdOw0KICAgICAgZnVuY3Rpb24gaWZOb0RhdGFGdW5jKC4uLnZhbHMpIHsNCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgY29uc3QgdmFsID0gdmFsc1tpXTsNCiAgICAgICAgICAgICAgaWYgKGlzTmFOKHZhbCkgfHwgdmFsID09PSBub0RhdGEpIHsNCiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGlmIChmaWxsKSB7DQogICAgICAgICAgY29uc3QgeyBtaW4sIG1heCwgcmFuZ2UgfSA9IHJhbmdlc1swXTsNCiAgICAgICAgICBjb25zdCB7IHR5cGUgPSAnY29udGludW91cycsIGNvbG9ycywgbW9kZSA9ICdyZ2InIH0gPSBmaWxsOw0KICAgICAgICAgIGxldCBzdG9wczsNCiAgICAgICAgICBpZiAodHlwZW9mIGNvbG9yc1swXSA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgICAgY29uc3Qgc3RlcCA9IHJhbmdlIC8gY29sb3JzLmxlbmd0aDsNCiAgICAgICAgICAgICAgc3RvcHMgPSBjb2xvcnMubWFwKChjb2xvciwgaW5kZXgpID0+IHsNCiAgICAgICAgICAgICAgICAgIHJldHVybiBbbWluICsgaW5kZXggKiBzdGVwLCBjb2xvcl07DQogICAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0NCiAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgc3RvcHMgPSBjb2xvcnMuc29ydCgoYSwgYikgPT4gYVswXSAtIGJbMF0pOw0KICAgICAgICAgICAgICBpZiAoc3RvcHNbMF1bMF0gPiBtaW4pIHsNCiAgICAgICAgICAgICAgICAgIHN0b3BzWzBdWzBdID0gbWluOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGlmIChzdG9wc1tzdG9wcy5sZW5ndGggLSAxXVswXSA8IG1heCkgew0KICAgICAgICAgICAgICAgICAgc3RvcHNbc3RvcHMubGVuZ3RoXSA9IFttYXgsIHN0b3BzW3N0b3BzLmxlbmd0aCAtIDFdWzFdXTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFbMF0ubGVuZ3RoOyBpICs9IDEpIHsNCiAgICAgICAgICAgICAgY29uc3QgdmFsID0gcmVkRGF0YVtpXTsNCiAgICAgICAgICAgICAgbGV0IGNvbG9yID0gJ3RyYW5zcGFyZW50JzsNCiAgICAgICAgICAgICAgY29uc3QgaWZOb0RhdGEgPSBpZk5vRGF0YUZ1bmModmFsKTsNCiAgICAgICAgICAgICAgaWYgKCFpZk5vRGF0YSkgew0KICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzdG9wcy5sZW5ndGg7IGogKz0gMSkgew0KICAgICAgICAgICAgICAgICAgICAgIGlmICgodmFsID49IHN0b3BzW2pdWzBdICYmICghc3RvcHNbaiArIDFdIHx8ICh2YWwgPCBzdG9wc1tqICsgMV1bMF0pKSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdjb250aW51b3VzJykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBsaW5lYXIoKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5kb21haW4oc3RvcHMubWFwKGl0ZW0gPT4gKGl0ZW1bMF0gLSBtaW4pIC8gcmFuZ2UpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yYW5nZShzdG9wcy5tYXAoaXRlbSA9PiBpdGVtWzFdKSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaW50ZXJwb2xhdGUoaW50ZXJwb2xhdGVGYWN0b3J5c1ttb2RlXSkoKHZhbCAtIG1pbikgLyByYW5nZSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9IHN0b3BzW2pdWzFdOw0KICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBjb25zdCB7IHIsIGcsIGIsIG9wYWNpdHkgfSA9IHJnYihjb2xvcik7DQogICAgICAgICAgICAgIGltYWdlRGF0YVtpICogNF0gPSByOw0KICAgICAgICAgICAgICBpbWFnZURhdGFbaSAqIDQgKyAxXSA9IGc7DQogICAgICAgICAgICAgIGltYWdlRGF0YVtpICogNCArIDJdID0gYjsNCiAgICAgICAgICAgICAgaW1hZ2VEYXRhW2kgKiA0ICsgM10gPSBpZk5vRGF0YSA/IDAgOiBkZWNpbWFsMnJnYihvcGFjaXR5KTsNCiAgICAgICAgICB9DQogICAgICB9DQogICAgICBlbHNlIHsNCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFbMF0ubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgY29uc3QgcmVkID0gcmVkRGF0YVtpXTsNCiAgICAgICAgICAgICAgY29uc3QgZ3JlZW4gPSBncmVlbkRhdGFbaV07DQogICAgICAgICAgICAgIGNvbnN0IGJsdWUgPSBibHVlRGF0YVtpXTsNCiAgICAgICAgICAgICAgaW1hZ2VEYXRhW2kgKiA0XSA9IGRlY2ltYWwycmdiKChyZWQgLSByYW5nZXNbMF0ubWluKSAvIHJhbmdlc1swXS5yYW5nZSk7DQogICAgICAgICAgICAgIGltYWdlRGF0YVtpICogNCArIDFdID0gZGVjaW1hbDJyZ2IoKGdyZWVuIC0gcmFuZ2VzWzFdLm1pbikgLyByYW5nZXNbMV0ucmFuZ2UpOw0KICAgICAgICAgICAgICBpbWFnZURhdGFbaSAqIDQgKyAyXSA9IGRlY2ltYWwycmdiKChibHVlIC0gcmFuZ2VzWzJdLm1pbikgLyByYW5nZXNbMl0ucmFuZ2UpOw0KICAgICAgICAgICAgICBpbWFnZURhdGFbaSAqIDQgKyAzXSA9IGlmTm9EYXRhRnVuYyhyZWQsIGdyZWVuLCBibHVlKSA/IDAgOiAyNTU7DQogICAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEltYWdlRGF0YShpbWFnZURhdGEsIHdpZHRoLCBoZWlnaHQpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgfQoKICBjb25zdCB3b3JrID0gc2VsZjsNCiAgd29yay5vbm1lc3NhZ2UgPSBhc3luYyBmdW5jdGlvbiAobXNnKSB7DQogICAgICBjb25zdCB7IGlkLCBwYXlsb2FkIH0gPSBtc2cuZGF0YTsNCiAgICAgIGlmIChpZCA9PSBudWxsKQ0KICAgICAgICAgIHJldHVybjsNCiAgICAgIGNvbnN0IHsgZGF0YSwgb3B0cyB9ID0gcGF5bG9hZDsNCiAgICAgIHRyeSB7DQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2VuZXJhdGVJbWFnZShkYXRhLCBvcHRzKTsNCiAgICAgICAgICB3b3JrLnBvc3RNZXNzYWdlKHsgaWQsIHBheWxvYWQ6IHJlc3VsdCB9KTsNCiAgICAgIH0NCiAgICAgIGNhdGNoIChlcnIpIHsNCiAgICAgICAgICB3b3JrLnBvc3RNZXNzYWdlKHsgaWQsIGVycjogU3RyaW5nKGVycikgfSk7DQogICAgICB9DQogIH07Cgp9KSgpOwovLyMgc291cmNlTWFwcGluZ1VSTD13b3JrZXIuanMubWFwCgo=', null, false);
/* eslint-enable */

// @ts-ignore
const resolves = {};
const rejects = {};
let globalMsgId = 0; // Activate calculation in the worker, returning a promise
async function sendMessage(worker, payload) {
    const msgId = globalMsgId++;
    const msg = {
        id: msgId,
        payload,
    };
    return new Promise(function (resolve, reject) {
        // save callbacks for later
        resolves[msgId] = resolve;
        rejects[msgId] = reject;
        worker.postMessage(msg);
    });
} // Handle incoming calculation result
function handleMessage(msg) {
    const { id, err, payload } = msg.data;
    if (payload) {
        const resolve = resolves[id];
        if (resolve) {
            resolve(payload);
        }
    }
    else {
        // error condition
        const reject = rejects[id];
        if (reject) {
            if (err) {
                reject(err);
            }
            else {
                reject("Got nothing");
            }
        }
    }
    // purge used callbacks
    delete resolves[id];
    delete rejects[id];
}
class WorkerFarm {
    worker;
    constructor() {
        this.worker = new WorkerFactory();
        this.worker.onmessage = handleMessage;
    }
    async scheduleTask(data, opts) {
        return await sendMessage(this.worker, { data, opts });
    }
    destory() {
        this.worker.terminate();
        this.worker = undefined;
    }
}

function getMinMax(data, nodata) {
    let min, max;
    for (let j = 0; j < data.length; j += 1) {
        const val = data[j];
        if (val === nodata)
            continue;
        if (min === undefined && max === undefined) {
            min = max = val;
            continue;
        }
        if (val < min) {
            min = val;
        }
        else if (val > max) {
            max = val;
        }
    }
    return {
        min, max
    };
}
class TIFFImageryProvider {
    options;
    ready;
    tilingScheme;
    rectangle;
    tileSize;
    tileWidth;
    tileHeight;
    maximumLevel;
    minimumLevel;
    credit;
    _error;
    readyPromise;
    _destroyed = false;
    _source;
    _imageCount;
    _images = [];
    _imagesCache = {};
    bands;
    noData;
    hasAlphaChannel;
    _pool;
    _workerFarm;
    constructor(options) {
        this.options = options;
        this.ready = false;
        this.hasAlphaChannel = options.hasAlphaChannel ?? true;
        this.maximumLevel = options.maximumLevel ?? 18;
        this.minimumLevel = options.minimumLevel ?? 0;
        this.credit = new Credit(options.credit || "", false);
        this._error = new Event();
        this._workerFarm = this.options.webWorker !== false ? new WorkerFarm() : null;
        this.readyPromise = fromUrl(options.url, {
            allowFullFile: true
        }).then(async (res) => {
            this._pool = new Pool();
            this._source = res;
            const image = await res.getImage();
            this._imageCount = await res.getImageCount();
            this.tileSize = this.tileWidth = this.tileHeight = options.tileSize || image.getTileWidth() || 512;
            // nodata
            const noData = image.getGDALNoData();
            this.noData = options.renderOptions.nodata ?? noData;
            const bands = [];
            // 
            const samples = image.getSamplesPerPixel();
            for (let i = 0; i < samples; i++) {
                // 
                const element = image.getGDALMetadata(i);
                if (element?.STATISTICS_MINIMUM && element?.STATISTICS_MAXIMUM) {
                    bands.push({
                        min: element.STATISTICS_MINIMUM,
                        max: element.STATISTICS_MAXIMUM,
                    });
                }
                else {
                    const previewImage = await res.getImage();
                    const data = (await previewImage.readRasters({
                        samples: [i],
                        pool: this._pool,
                    }))[0].filter((item) => !isNaN(item));
                    bands.push(getMinMax(data, noData));
                }
            }
            this.bands = bands;
            // 
            const bbox = image.getBoundingBox();
            const [west, south, east, north] = bbox;
            const prjCode = +(image.geoKeys.ProjectedCSTypeGeoKey ?? image.geoKeys.GeographicTypeGeoKey);
            const { projFunc } = options;
            const proj = projFunc?.(prjCode);
            if (typeof proj === 'function') {
                const leftBottom = proj([west, south]);
                const rightTop = proj([east, north]);
                this.rectangle = Rectangle.fromDegrees(leftBottom[0], leftBottom[1], rightTop[0], rightTop[1]);
            }
            else if (prjCode === 4326) {
                this.rectangle = Rectangle.fromDegrees(...bbox);
            }
            else if (prjCode === 3857 || prjCode === 900913) {
                this.rectangle = Rectangle.fromCartesianArray([new Cartesian3(west, south), new Cartesian3(east, north)]);
            }
            else {
                const error = new Error(`Unspported projection type: EPSG:${prjCode}, please add projFunc parameter to handle projection`);
                throw error;
            }
            // 180
            // https://github.com/CesiumGS/cesium/blob/da00d26473f663db180cacd8e662ca4309e09560/packages/engine/Source/Core/TileAvailability.js#L195
            if (this.rectangle.east < this.rectangle.west) {
                this.rectangle.east += Math$1.TWO_PI;
            }
            this.tilingScheme = new GeographicTilingScheme({
                rectangle: this.rectangle,
                numberOfLevelZeroTilesX: 1,
                numberOfLevelZeroTilesY: 1
            });
            this.maximumLevel = this.maximumLevel >= this._imageCount ? this._imageCount - 1 : this.maximumLevel;
            this._images = new Array(this._imageCount).fill(null);
            this.ready = true;
        });
    }
    /**
     * Gets an event that will be raised if an error is encountered during processing.
     * @memberof GeoJsonDataSource.prototype
     * @type {Event}
     */
    get errorEvent() {
        return this._error;
    }
    get isDestroyed() {
        return this._destroyed;
    }
    _getIndex(level) {
        const z = level > this._imageCount ? this._imageCount : level;
        const index = this._imageCount - z - 1;
        return index;
    }
    /**
     * 
     * @param x
     * @param y
     * @param z
     */
    async _loadTile(x, y, z) {
        const { tileSize } = this;
        const index = this._getIndex(z);
        let image = this._images[index];
        if (!image) {
            image = this._images[index] = await this._source.getImage(index);
        }
        const width = image.getWidth();
        const height = image.getHeight();
        const tileXNum = this.tilingScheme.getNumberOfXTilesAtLevel(z);
        const tileYNum = this.tilingScheme.getNumberOfYTilesAtLevel(z);
        const tilePixel = {
            xWidth: width / tileXNum,
            yWidth: height / tileYNum
        };
        const pixelBounds = [
            Math.round(x * tilePixel.xWidth),
            Math.round(y * tilePixel.yWidth),
            Math.round((x + 1) * tilePixel.xWidth),
            Math.round((y + 1) * tilePixel.yWidth),
        ];
        const promise = image.readRasters({
            window: pixelBounds,
            width: tileSize,
            height: tileSize,
            fillValue: this.noData,
            pool: this._pool,
        });
        return promise
            .then((res) => {
            return res;
        })
            .catch((error) => {
            this._error.raiseEvent(error);
            throw error;
        });
    }
    async requestImage(x, y, z) {
        if (!this.ready) {
            throw new DeveloperError("requestImage must not be called before the imagery provider is ready.");
        }
        if (z < this.minimumLevel || z > this.maximumLevel || z > this._imageCount)
            return undefined;
        if (this._imagesCache[`${x}_${y}_${z}`])
            return this._imagesCache[`${x}_${y}_${z}`];
        const width = this.tileSize;
        const height = this.tileSize;
        const { renderOptions } = this.options;
        try {
            const data = await this._loadTile(x, y, z);
            const opts = {
                width,
                height,
                renderOptions,
                bands: this.bands,
                noData: this.noData
            };
            let result;
            if (this._workerFarm?.worker) {
                result = await this._workerFarm.scheduleTask(data, opts);
            }
            else {
                result = undefined;
            }
            this._imagesCache[`${x}_${y}_${z}`] = result;
            return result;
        }
        catch (e) {
            this._error.raiseEvent(e);
            throw e;
        }
    }
    async pickFeatures(x, y, zoom, longitude, latitude) {
        if (!this.options.enablePickFeatures)
            return undefined;
        const z = zoom > this._imageCount ? this._imageCount : zoom;
        const index = this._getIndex(z);
        let image = this._images[index];
        if (!image) {
            image = this._images[index] = await this._source.getImage(index);
        }
        const { west, south, north, width: lonWidth } = this.rectangle;
        const width = image.getWidth();
        const height = image.getHeight();
        let lonGap = longitude - west;
        // 180
        if (longitude < west) {
            lonGap += Math$1.TWO_PI;
        }
        const posX = ~~(Math.abs(lonGap / lonWidth) * width);
        const posY = ~~(Math.abs((north - latitude) / (north - south)) * height);
        const res = await image.readRasters({
            window: [posX, posY, posX + 1, posY + 1],
            height: 1,
            width: 1,
            pool: this._pool,
        });
        const featureInfo = new ImageryLayerFeatureInfo();
        featureInfo.name = `lon:${(longitude / Math.PI * 180).toFixed(6)}, lat:${(latitude / Math.PI * 180).toFixed(6)}`;
        featureInfo.data = res[0];
        if (res) {
            featureInfo.configureDescriptionFromProperties(res[0]);
        }
        return [featureInfo];
    }
    destroy() {
        this._images = undefined;
        this._imagesCache = undefined;
        this._workerFarm?.destory();
        this._destroyed = true;
    }
}

export { TIFFImageryProvider, TIFFImageryProvider as default };
//# sourceMappingURL=index.js.map
